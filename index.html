<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å¼ºåˆ¶ç«–å±ï¼Œç¦æ­¢ç¼©æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Web MOBA: ä¼˜åŒ–ç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000;
            font-family: sans-serif;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* æ¸¸æˆåŒº 65% */
        #game-container {
            width: 100%; height: 65%;
            position: relative; background: #161616; border-bottom: 2px solid #333;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* HUD */
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #top-bar { display: flex; justify-content: space-between; padding: 10px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 12px;}
        .team-blue { color: #4ecdc4; } .team-red { color: #e74c3c; }

        /* æ§åˆ¶åŒº 35% */
        #controls-area {
            width: 100%; height: 35%; background-color: #222;
            position: relative; display: flex;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        /* æ‘‡æ† */
        #joystick-container {
            width: 40%; height: 100%; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        #joystick-base {
            width: 110px; height: 110px; background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; position: relative;
        }
        #joystick-stick {
            width: 40px; height: 40px; background: linear-gradient(135deg, #4ecdc4, #2a9d8f);
            border-radius: 50%; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* æŠ€èƒ½åŒº */
        #skills-container { width: 60%; height: 100%; position: relative; }
        .skill-btn {
            position: absolute; width: 50px; height: 50px; background: #333;
            border: 2px solid #555; border-radius: 50%; color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; box-shadow: 0 4px 5px rgba(0,0,0,0.4);
        }
        .skill-btn:active { background: #555; transform: scale(0.95); }
        
        /* å¸ƒå±€è°ƒæ•´ */
        .p-q { bottom: 20px; right: 120px; }
        .p-w { bottom: 80px; right: 100px; }
        .p-e { bottom: 120px; right: 30px; }
        .p-r { bottom: 150px; right: 110px; width: 45px!important; height: 45px!important; border-color: gold; background: #440;} 
        .p-aa{ bottom: 20px; right: 20px; width: 75px!important; height: 75px!important; background: #444; font-size: 20px;} 

        .cd-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            border-radius: 50%; background: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center; color: #fff;
        }

        /* å¼¹çª— */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 999;
        }
        .hidden { display: none !important; }
        .h-card { width: 80px; padding: 15px; background: #222; border: 1px solid #444; border-radius: 8px; text-align: center; color: white; margin: 5px;}
        h1 { color: #ffd700; margin-bottom: 20px; font-size: 24px; }
        .btn-main { padding: 10px 25px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 6px; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="selection-screen" class="overlay-screen">
        <h1>é€‰æ‹©è‹±é›„</h1>
        <div style="display:flex;">
            <div class="h-card" onclick="startGame('mage')">ğŸ”µ<br>æ³•å¸ˆ</div>
            <div class="h-card" onclick="startGame('shooter')">ğŸ¹<br>å°„æ‰‹</div>
            <div class="h-card" onclick="startGame('warrior')">ğŸ›¡ï¸<br>æˆ˜å£«</div>
        </div>
    </div>

    <div id="end-screen" class="overlay-screen hidden">
        <h1 id="end-msg">ç»“æŸ</h1>
        <button class="btn-main" onclick="location.reload()">è¿”å›</button>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="hud-layer">
            <div id="top-bar">
                <div onclick="location.reload()">ğŸ </div>
                <div class="team-red">æ•Œå¡”: <span id="hp-red">5000</span></div>
            </div>
            <div style="position:absolute; bottom:10px; left:10px;" class="team-blue">æˆ‘å¡”: <span id="hp-blue">5000</span></div>
        </div>
    </div>

    <div id="controls-area">
        <div id="joystick-container">
            <div id="joystick-base"><div id="joystick-stick"></div></div>
        </div>
        <div id="skills-container">
            <div class="skill-btn p-aa" ontouchstart="handleSkill(event, 'AA')">âš”ï¸</div>
            <div class="skill-btn p-q" ontouchstart="handleSkill(event, 'Q')">Q<div id="cd-q" class="cd-overlay"></div></div>
            <div class="skill-btn p-w" ontouchstart="handleSkill(event, 'W')">W<div id="cd-w" class="cd-overlay"></div></div>
            <div class="skill-btn p-e" ontouchstart="handleSkill(event, 'E')">E<div id="cd-e" class="cd-overlay"></div></div>
            <div class="skill-btn p-r" ontouchstart="handleSkill(event, 'R')">R<div id="cd-r" class="cd-overlay"></div></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('game-container');
        
        function resize() {
            canvas.width = gameContainer.clientWidth;
            canvas.height = gameContainer.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- é…ç½®å‚æ•° (é€Ÿåº¦å…¨é¢é™ä½) ---
        const CONFIG = {
            speed: {
                hero: { mage: 2.0, shooter: 2.2, warrior: 2.0 },
                minion: 0.8,
                bullet: 5.0
            },
            spawnRate: 500 // çº¦8ç§’ç”Ÿæˆä¸€æ³¢ (60fps)
        };

        const HEROES = {
            mage: { hp:900, speed: CONFIG.speed.hero.mage, cd:{Q:40,W:300,E:180,R:600} },
            shooter: { hp:700, speed: CONFIG.speed.hero.shooter, cd:{Q:20,W:180,E:300,R:900} },
            warrior: { hp:1600, speed: CONFIG.speed.hero.warrior, cd:{Q:30,W:240,E:360,R:700} }
        };

        let gameState = 'MENU';
        let player, enemy, blueTower, redTower;
        let units=[], bullets=[], effects=[], texts=[];
        let joystick = { active:false, dx:0, dy:0, angle: -Math.PI/2 };

        // --- å®ä½“ç±» ---
        class Entity {
            constructor(x,y,r,c,team,hp,maxHp) {
                this.x=x; this.y=y; this.r=r; this.c=c; this.team=team;
                this.hp=hp; this.maxHp=maxHp; this.dead=false;
                this.pushX=0; this.pushY=0; // ç”¨äºç¢°æ’æ¨æŒ¤
            }
            draw(ctx) {
                // ç»˜åˆ¶è¡€æ¡
                let pct = Math.max(0, this.hp/this.maxHp);
                ctx.fillStyle='#333'; ctx.fillRect(this.x-15, this.y-this.r-8, 30, 4);
                ctx.fillStyle=this.team==='blue'?'#4ecdc4':'#e74c3c'; ctx.fillRect(this.x-15, this.y-this.r-8, 30*pct, 4);
            }
            hit(dmg) {
                if(this.dead) return;
                this.hp-=dmg;
                texts.push({x:this.x, y:this.y-20, val:Math.floor(dmg), life:40});
                if(this.hp<=0) {
                    this.dead=true; this.hp=0;
                    effects.push({type:'explode', x:this.x, y:this.y, r:this.r*1.5, c:this.c, life:20});
                }
            }
        }

        class Hero extends Entity {
            constructor(x,y,team,type) {
                super(x,y, 18, team==='blue'?'#3498db':'#e74c3c', team, HEROES[type].hp, HEROES[type].hp);
                this.cfg = HEROES[type];
                this.type = type;
                this.cds = {Q:0,W:0,E:0,R:0,AA:0};
                this.face = team==='blue'? -Math.PI/2 : Math.PI/2; 
            }
            update() {
                for(let k in this.cds) if(this.cds[k]>0) this.cds[k]--;
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                // æœå‘æŒ‡ç¤ºå™¨
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(this.face)*30, Math.sin(this.face)*30); 
                ctx.strokeStyle='rgba(255,255,255,0.4)'; ctx.lineWidth=2; ctx.stroke();
                
                ctx.fillStyle=this.c;
                if(this.type==='mage') { ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.fill(); }
                else if(this.type==='warrior') ctx.fillRect(-14,-14,28,28);
                else { ctx.beginPath();ctx.moveTo(0,-15);ctx.lineTo(12,10);ctx.lineTo(-12,10);ctx.fill(); }
                ctx.restore();
                super.draw(ctx);
            }
        }

        // --- æ¸¸æˆåˆå§‹åŒ– ---
        function initGame(heroType) {
            document.getElementById('selection-screen').classList.add('hidden');
            resize();

            let cx = canvas.width/2;
            let h = canvas.height;

            // åˆå§‹åŒ–å¡”
            blueTower = {x:cx, y:h-60, r:30, c:'#3498db', team:'blue', hp:5000, maxHp:5000, dead:false, spawnT:0, atkT:0};
            redTower = {x:cx, y:60, r:30, c:'#e74c3c', team:'red', hp:5000, maxHp:5000, dead:false, spawnT:0, atkT:0};
            
            // å¡”çš„æ–¹æ³•ç»‘å®š
            [blueTower, redTower].forEach(t => {
                t.draw = Entity.prototype.draw.bind(t);
                t.hit = Entity.prototype.hit.bind(t);
            });

            player = new Hero(cx, h-120, 'blue', heroType);
            enemy = new Hero(cx, 120, 'red', 'warrior');

            units=[]; bullets=[]; effects=[]; texts=[];
            gameState = 'PLAYING';
            loop();
        }

        // --- ä¸»å¾ªç¯ ---
        function update() {
            // å¤æ´»é€»è¾‘
            if(player.dead && Math.random()<0.005) {player.dead=false; player.hp=player.maxHp; player.x=blueTower.x; player.y=blueTower.y;}
            if(enemy.dead && Math.random()<0.005) {enemy.dead=false; enemy.hp=enemy.maxHp; enemy.x=redTower.x; enemy.y=redTower.y;}

            // ç©å®¶ç§»åŠ¨
            if(!player.dead) {
                player.update();
                if(joystick.active) {
                    player.x += joystick.dx * player.cfg.speed;
                    player.y += joystick.dy * player.cfg.speed;
                    player.face = joystick.angle;
                    player.x = Math.max(15, Math.min(canvas.width-15, player.x));
                    player.y = Math.max(15, Math.min(canvas.height-15, player.y));
                }
                // UI CDæ›´æ–°
                ['Q','W','E','R'].forEach(k=>{
                    let div = document.getElementById('cd-'+k.toLowerCase());
                    if(player.cds[k]>0) { div.style.display='flex'; div.innerText = Math.ceil(player.cds[k]/60); }
                    else div.style.display='none';
                });
            }

            // æ•Œäººç®€å•AI
            if(!enemy.dead) {
                enemy.update();
                let d = Math.hypot(player.x-enemy.x, player.y-enemy.y);
                let tx = blueTower.x, ty = blueTower.y; // é»˜è®¤æ¨å¡”
                if(enemy.hp<enemy.maxHp*0.3) { tx=redTower.x; ty=redTower.y; } // æ’¤é€€
                else if(d<300) { tx=player.x; ty=player.y; } // è¿½äºº
                
                let ang = Math.atan2(ty-enemy.y, tx-enemy.x);
                if(Math.hypot(tx-enemy.x, ty-enemy.y)>60) {
                    enemy.x += Math.cos(ang)*enemy.cfg.speed; enemy.y += Math.sin(ang)*enemy.cfg.speed;
                    enemy.face = ang;
                }
                // AI æ™®æ”»
                if(enemy.cds.AA<=0 && d < 150) {
                    bullets.push({x:enemy.x, y:enemy.y, vx:Math.cos(ang)*CONFIG.speed.bullet, vy:Math.sin(ang)*CONFIG.speed.bullet, dmg:30, team:'red', life:60, r:5, c:'red'});
                    enemy.cds.AA = 80;
                }
            }

            // å¡”é€»è¾‘ (ç”Ÿæˆå…µ + æ”»å‡»)
            [blueTower, redTower].forEach(t => {
                if(t.dead) return;
                // 1. ç”Ÿæˆå…µ
                t.spawnT++;
                if(t.spawnT > CONFIG.spawnRate) {
                    // ä¸€æ¬¡ç”Ÿæˆ2ä¸ªå…µï¼Œé¿å…å¤ªå¤š
                    for(let i=0; i<2; i++) units.push(new Entity(t.x+(i-0.5)*30, t.y + (t.team==='blue'?-40:40), 10, t.c==='#3498db'?'#4ecdc4':'#ff6b6b', t.team, 120, 120));
                    t.spawnT = 0;
                }
                // 2. æ”»å‡»
                t.atkT--;
                if(t.atkT <= 0) {
                    let target = findNearest(t, 300);
                    if(target) {
                        let a = Math.atan2(target.y-t.y, target.x-t.x);
                        bullets.push({x:t.x, y:t.y, vx:Math.cos(a)*6, vy:Math.sin(a)*6, dmg:80, team:t.team, life:60, r:8, c:t.c});
                        t.atkT = 60; // 1ç§’ä¸€å‘
                    }
                }
            });

            // å°å…µé€»è¾‘ (ç§»åŠ¨ + é˜²é‡å )
            units.forEach((u,i) => {
                if(u.dead) { units.splice(i,1); return; }
                
                // å¯»æ‰¾ç›®æ ‡
                let t = findNearest(u, 200);
                let targetX = u.team==='blue' ? redTower.x : blueTower.x;
                let targetY = u.team==='blue' ? redTower.y : blueTower.y;
                
                if(t) {
                    // æœ‰æ•Œäººå°±é è¿‘
                    if(Math.hypot(t.x-u.x, t.y-u.y) < 80) {
                        // å°„ç¨‹å†…ï¼Œå¼€ç«(ç®€å•æ¦‚ç‡)
                        if(Math.random()<0.02) bullets.push({x:u.x, y:u.y, vx:(t.x-u.x)*0.03, vy:(t.y-u.y)*0.03, dmg:10, team:u.team, life:30, r:3, c:u.c});
                    } else {
                        u.x += (t.x-u.x)*0.01; u.y += (t.y-u.y)*0.01;
                    }
                } else {
                    // æ— æ•Œäººæ¨å¡”
                    let ang = Math.atan2(targetY-u.y, targetX-u.x);
                    u.x += Math.cos(ang) * CONFIG.speed.minion;
                    u.y += Math.sin(ang) * CONFIG.speed.minion;
                }

                // é˜²é‡å  (Boids separation)
                units.forEach(other => {
                    if(u !== other && !other.dead) {
                        let dist = Math.hypot(u.x-other.x, u.y-other.y);
                        if(dist < 20) { // æŒ¤åœ¨ä¸€èµ·äº†
                            let pushAng = Math.atan2(u.y-other.y, u.x-other.x);
                            u.x += Math.cos(pushAng) * 0.5;
                            u.y += Math.sin(pushAng) * 0.5;
                        }
                    }
                });
            });

            // å­å¼¹é€»è¾‘
            bullets.forEach((b,i) => {
                b.x+=b.vx; b.y+=b.vy; b.life--;
                let t = checkHit(b);
                if(t) { t.hit(b.dmg); b.life=0; }
                if(b.life<=0) bullets.splice(i,1);
            });

            // ç‰¹æ•ˆ
            effects.forEach((e,i) => {
                if(e.type==='area') {
                    e.timer--; if(e.timer<=0 && !e.done) { e.done=true; dealArea(e.x,e.y,e.r,e.dmg,e.team); effects.push({type:'explode', x:e.x, y:e.y, r:e.r, c:e.c, life:20}); }
                } 
                e.life--; 
                if(e.life<=0 || (e.done && e.type==='area')) if(e.type!=='area'||e.done) effects.splice(i,1);
            });

            // é£˜å­—
            texts.forEach((t,i) => {t.y-=0.5; t.life--; if(t.life<=0) texts.splice(i,1);});

            // åˆ·æ–°UIè¡€é‡
            document.getElementById('hp-blue').innerText = Math.max(0, Math.floor(blueTower.hp));
            document.getElementById('hp-red').innerText = Math.max(0, Math.floor(redTower.hp));

            if(blueTower.hp<=0 || redTower.hp<=0) {
                gameState = 'END';
                document.getElementById('end-screen').classList.remove('hidden');
                document.getElementById('end-msg').innerText = redTower.hp<=0?"èƒœåˆ©!":"å¤±è´¥!";
                document.getElementById('end-msg').style.color = redTower.hp<=0?"#28a745":"#dc3545";
            }
        }

        function draw() {
            ctx.fillStyle = '#161616'; ctx.fillRect(0,0,canvas.width,canvas.height);
            // æ²³é“
            ctx.strokeStyle='#333'; ctx.beginPath(); ctx.moveTo(0,canvas.height/2); ctx.lineTo(canvas.width,canvas.height/2); ctx.stroke();

            // å¡”
            [blueTower, redTower].forEach(t => {
                if(!t.dead) {
                    ctx.fillStyle='#555'; ctx.beginPath(); ctx.arc(t.x,t.y,30,0,Math.PI*2); ctx.fill();
                    ctx.fillStyle=t.c; ctx.beginPath(); ctx.arc(t.x,t.y,20,0,Math.PI*2); ctx.fill();
                    t.draw(ctx);
                }
            });

            units.forEach(u => {if(!u.dead){ctx.fillStyle=u.c; ctx.beginPath(); ctx.arc(u.x,u.y,u.r,0,Math.PI*2); ctx.fill(); u.draw(ctx);}});
            if(!player.dead) player.draw(ctx);
            if(!enemy.dead) enemy.draw(ctx);

            bullets.forEach(b => { ctx.fillStyle=b.c; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); });
            
            // ç‰¹æ•ˆç»˜åˆ¶
            effects.forEach(e => {
                if(e.type==='explode') { ctx.globalAlpha=e.life/20; ctx.fillStyle=e.c; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
                if(e.type==='area' && !e.done) { ctx.strokeStyle=e.c; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.stroke(); ctx.fillStyle='rgba(255,255,255,0.1)'; ctx.fill(); }
                if(e.type==='laser') { 
                    ctx.save(); ctx.translate(e.x,e.y); ctx.rotate(e.a); 
                    ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.fillRect(0,-10,600,20); 
                    ctx.restore(); 
                }
                if(e.type==='slash') {
                    ctx.save(); ctx.translate(e.x,e.y); ctx.rotate(e.a);
                    ctx.strokeStyle='white'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,50,-0.5,0.5); ctx.stroke();
                    ctx.restore();
                }
            });

            texts.forEach(t => { ctx.fillStyle='white'; ctx.font='12px sans-serif'; ctx.fillText(t.val, t.x, t.y); });
        }

        function loop() {
            if(gameState==='PLAYING') { update(); draw(); requestAnimationFrame(loop); }
        }

        // --- è¾…åŠ©é€»è¾‘ ---
        function getTargets(myTeam) {
            let res=[];
            if(myTeam==='blue') { if(!redTower.dead)res.push(redTower); if(!enemy.dead)res.push(enemy); units.forEach(u=>{if(u.team==='red')res.push(u)}); }
            else { if(!blueTower.dead)res.push(blueTower); if(!player.dead)res.push(player); units.forEach(u=>{if(u.team==='blue')res.push(u)}); }
            return res;
        }
        function findNearest(me, range=9999) {
            let min=range, res=null;
            getTargets(me.team).forEach(t => { let d=Math.hypot(t.x-me.x, t.y-me.y); if(d<min){min=d; res=t;} });
            return res;
        }
        function checkHit(b) {
            for(let t of getTargets(b.team)) if(Math.hypot(t.x-b.x, t.y-b.y) < t.r+b.r) return t;
            return null;
        }
        function dealArea(x,y,r,dmg,team) {
            getTargets(team).forEach(t => { if(Math.hypot(t.x-x, t.y-y) < r+t.r) t.hit(dmg); });
        }

        // --- è§¦æ‘¸æ§åˆ¶ ---
        const jz = document.getElementById('joystick-container');
        const jb = document.getElementById('joystick-base');
        const js = document.getElementById('joystick-stick');
        let jStart = {x:0, y:0};

        jz.addEventListener('touchstart', e => {
            e.preventDefault();
            let rect = jb.getBoundingClientRect();
            jStart = {x:rect.left+rect.width/2, y:rect.top+rect.height/2};
            joystick.active = true;
            moveJoy(e.changedTouches[0]);
        }, {passive:false});
        jz.addEventListener('touchmove', e => {e.preventDefault(); if(joystick.active) moveJoy(e.changedTouches[0]);}, {passive:false});
        const endJoy = e => {e.preventDefault(); joystick.active=false; js.style.transform=`translate(-50%,-50%)`;};
        jz.addEventListener('touchend', endJoy); jz.addEventListener('touchcancel', endJoy);

        function moveJoy(t) {
            let dx=t.clientX-jStart.x, dy=t.clientY-jStart.y;
            let d=Math.min(35, Math.hypot(dx,dy));
            let a=Math.atan2(dy,dx);
            joystick.dx=Math.cos(a); joystick.dy=Math.sin(a); joystick.angle=a;
            js.style.transform=`translate(calc(-50% + ${joystick.dx*d}px), calc(-50% + ${joystick.dy*d}px))`;
        }

        window.handleSkill = function(e, k) {
            e.preventDefault();
            if(player.dead) return;

            // AA æ™®æ”»é€»è¾‘ (éæŒ‡å‘æ€§)
            if(k==='AA') {
                // å¯»æ‰¾æœ€è¿‘æ•Œäººç¡®å®šæ–¹å‘ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±æœå‘è‡ªå·±é¢æœæ–¹å‘
                let t = findNearest(player, 400);
                let angle = player.face;
                if(t) angle = Math.atan2(t.y-player.y, t.x-player.x);
                
                // å‘å°„ç›´çº¿å­å¼¹
                bullets.push({
                    x:player.x, y:player.y, 
                    vx:Math.cos(angle)*CONFIG.speed.bullet, vy:Math.sin(angle)*CONFIG.speed.bullet, 
                    dmg:40, team:'blue', life:50, r:5, c:'#fff'
                });
                return;
            }
            
            // æŠ€èƒ½
            if(player.cds[k]>0) return;
            let t = findNearest(player, 400);
            let tx = t ? t.x : player.x+Math.cos(player.face)*150;
            let ty = t ? t.y : player.y+Math.sin(player.face)*150;
            let a = Math.atan2(ty-player.y, tx-player.x);

            if(k==='Q') {
                if(player.type==='warrior') {
                    effects.push({type:'slash', x:player.x, y:player.y, a:a, life:15});
                    dealArea(player.x+Math.cos(a)*60, player.y+Math.sin(a)*60, 70, 100, 'blue');
                } else {
                    bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*6, vy:Math.sin(a)*6, dmg:120, team:'blue', life:50, r:12, c:'cyan'});
                }
            }
            if(k==='W') { player.x+=Math.cos(a)*80; player.y+=Math.sin(a)*80; effects.push({type:'explode',x:player.x,y:player.y,r:20,c:'white',life:10}); }
            if(k==='E') { effects.push({type:'area', x:tx, y:ty, r:60, c:'orange', dmg:120, team:'blue', timer:40, done:false}); }
            if(k==='R') { 
                if(player.type==='mage') effects.push({type:'laser', x:player.x, y:player.y, a:a, team:'blue', dmg:400, life:20});
                else if(player.type==='shooter') bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*15, vy:Math.sin(a)*15, dmg:400, team:'blue', life:50, r:15, c:'magenta'});
                else effects.push({type:'area', x:player.x, y:player.y, r:200, c:'#8B4513', dmg:350, team:'blue', timer:40, done:false});
            }
            
            player.cds[k] = player.cfg.cd[k];
        };

        window.startGame = function(t) { initGame(t); }
    </script>
</body>
</html>
