<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å¼ºåˆ¶ç«–å±ï¼Œç¦æ­¢ç¼©æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Web MOBA: ç«–å±ç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
            touch-action: none; /* ç¦æ­¢æµè§ˆå™¨é»˜è®¤æ»‘åŠ¨ */
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            display: flex; flex-direction: column; /* å‚ç›´å¸ƒå±€ */
        }

        /* --- 1. æ¸¸æˆç”»é¢åŒºåŸŸ (ä¸Š 65%) --- */
        #game-container {
            width: 100%;
            height: 65%;
            position: relative;
            background: #161616;
            border-bottom: 2px solid #333;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI ä¿¡æ¯å±‚ (è¡€é‡ã€è¿”å›æŒ‰é’®) */
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        #top-bar {
            display: flex; justify-content: space-between; padding: 10px;
            color: white; font-size: 12px; font-weight: bold; text-shadow: 1px 1px 2px black;
        }
        .team-blue { color: #4ecdc4; }
        .team-red { color: #e74c3c; }
        #home-btn {
            pointer-events: auto; cursor: pointer; font-size: 20px;
        }

        /* --- 2. æ“æ§åŒºåŸŸ (ä¸‹ 35%) --- */
        #controls-area {
            width: 100%;
            height: 35%; /* å‰©ä½™ç©ºé—´ */
            background-color: #222;
            position: relative;
            display: flex;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        /* å·¦ä¾§ï¼šæ‘‡æ†åŒº */
        #joystick-container {
            width: 40%; height: 100%;
            position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        #joystick-base {
            width: 120px; height: 120px;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            position: relative;
        }
        #joystick-stick {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, #4ecdc4, #2a9d8f);
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* å³ä¾§ï¼šæŠ€èƒ½åŒº */
        #skills-container {
            width: 60%; height: 100%;
            position: relative;
        }
        /* æŠ€èƒ½æŒ‰é’®å¸ƒå±€ï¼šå¼§å½¢æˆ–è€…ç½‘æ ¼ï¼Œè¿™é‡Œç”¨è±å½¢å¸ƒå±€æ–¹ä¾¿æ‹‡æŒ‡ */
        .skill-btn {
            position: absolute;
            width: 55px; height: 55px;
            background: #333;
            border: 2px solid #555;
            border-radius: 50%;
            color: white; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            box-shadow: 0 4px 5px rgba(0,0,0,0.4);
        }
        .skill-btn:active { background: #555; transform: scale(0.95); }
        .btn-r { width: 65px; height: 65px; border-color: #ffd700; background: #3a3a00; font-size: 20px; }
        
        /* æŠ€èƒ½ä½ç½®å®šä½ (åŸºäºå³ä¸‹è§’) */
        #btn-aa { bottom: 30px; right: 30px; width: 70px; height: 70px; background: #444; font-size: 12px;} /* æ™®æ”»å¤§ä¸€ç‚¹ */
        #btn-q { bottom: 30px; right: 110px; }
        #btn-w { bottom: 100px; right: 100px; }
        #btn-e { bottom: 120px; right: 30px; }
        #btn-r { bottom: 180px; right: 10px; width: 50px; height: 50px; border-color: gold;} 
        
        /* ä¿®æ­£ä¸€ä¸‹å¸ƒå±€ï¼Œæ›´ç¬¦åˆæ‹‡æŒ‡å·¥å­¦ */
        /* ä»¥å³ä¸‹è§’ä¸ºåŸç‚¹ */
        .p-q { bottom: 20px; right: 130px; }
        .p-w { bottom: 90px; right: 110px; }
        .p-e { bottom: 130px; right: 40px; }
        .p-r { bottom: 160px; right: 120px; width: 50px!important; height: 50px!important; background: #440!important;} 
        .p-aa{ bottom: 30px; right: 30px; width: 80px; height: 80px; background: #555; border-color:#888;} 

        .cd-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            border-radius: 50%; background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            display: none;
        }

        /* --- å¼¹çª—æ ·å¼ --- */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 999;
        }
        .hidden { display: none !important; }
        
        .hero-select-box { display: flex; gap: 15px; margin-top: 20px; }
        .h-card { 
            width: 80px; padding: 15px; background: #222; border: 1px solid #444; 
            border-radius: 8px; text-align: center; color: white; 
        }
        .h-card:active { background: #444; border-color: #fff; }
        
        h1 { color: #ffd700; margin: 0 0 20px 0; font-size: 24px; }
        .btn-main { padding: 12px 30px; font-size: 18px; background: #28a745; color: white; border: none; border-radius: 6px; margin-top: 20px; }

    </style>
</head>
<body>

    <!-- é€‰äººç•Œé¢ -->
    <div id="selection-screen" class="overlay-screen">
        <h1>é€‰æ‹©ä½ çš„è‹±é›„</h1>
        <div class="hero-select-box">
            <div class="h-card" onclick="startGame('mage')">
                <div style="font-size:30px; margin-bottom:10px">ğŸ”µ</div>
                <div>æ³•å¸ˆ</div>
            </div>
            <div class="h-card" onclick="startGame('shooter')">
                <div style="font-size:30px; margin-bottom:10px">ğŸ¹</div>
                <div>å°„æ‰‹</div>
            </div>
            <div class="h-card" onclick="startGame('warrior')">
                <div style="font-size:30px; margin-bottom:10px">ğŸ›¡ï¸</div>
                <div>æˆ˜å£«</div>
            </div>
        </div>
    </div>

    <!-- ç»“ç®—ç•Œé¢ -->
    <div id="end-screen" class="overlay-screen hidden">
        <h1 id="end-msg">æ¸¸æˆç»“æŸ</h1>
        <button class="btn-main" onclick="location.reload()">è¿”å›ä¸»é¡µ</button>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="hud-layer">
            <div id="top-bar">
                <div id="home-btn" onclick="location.reload()">ğŸ </div>
                <div class="team-red">æ•Œæ–¹å¡”: <span id="hp-red">5000</span></div>
            </div>
            <div style="position:absolute; bottom:10px; left:10px; font-size:12px; font-weight:bold;" class="team-blue">æˆ‘æ–¹å¡”: <span id="hp-blue">5000</span></div>
        </div>
    </div>

    <!-- åº•éƒ¨æ“æ§åŒº -->
    <div id="controls-area">
        <!-- æ‘‡æ† -->
        <div id="joystick-container">
            <div id="joystick-base">
                <div id="joystick-stick"></div>
            </div>
        </div>
        <!-- æŠ€èƒ½ -->
        <div id="skills-container">
            <!-- æ™®æ”»é”® -->
            <div class="skill-btn p-aa" ontouchstart="handleSkill(event, 'AA')">âš”ï¸</div>
            <!-- æŠ€èƒ½é”® -->
            <div class="skill-btn p-q" ontouchstart="handleSkill(event, 'Q')">Q<div id="cd-q" class="cd-overlay"></div></div>
            <div class="skill-btn p-w" ontouchstart="handleSkill(event, 'W')">W<div id="cd-w" class="cd-overlay"></div></div>
            <div class="skill-btn p-e" ontouchstart="handleSkill(event, 'E')">E<div id="cd-e" class="cd-overlay"></div></div>
            <div class="skill-btn p-r" ontouchstart="handleSkill(event, 'R')">R<div id="cd-r" class="cd-overlay"></div></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- æ ¸å¿ƒï¼šè°ƒæ•´ç”»å¸ƒå°ºå¯¸ ---
        // ç”»å¸ƒåªå æ®ä¸Šæ–¹ div çš„å¤§å°ï¼Œè€Œä¸æ˜¯å…¨å±
        const gameContainer = document.getElementById('game-container');
        
        function resize() {
            canvas.width = gameContainer.clientWidth;
            canvas.height = gameContainer.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- æ¸¸æˆé€»è¾‘ ---
        let gameState = 'MENU';
        let player, enemy, blueTower, redTower;
        let units=[], bullets=[], effects=[], texts=[];
        let joystick = { active:false, dx:0, dy:0, angle: -Math.PI/2 }; // é»˜è®¤æœä¸Š

        // æ•°æ®é…ç½®
        const HEROES = {
            mage: { hp:900, speed:3.5, range:200, cd:{Q:40,W:300,E:180,R:600} },
            shooter: { hp:700, speed:4.0, range:350, cd:{Q:20,W:180,E:300,R:900} },
            warrior: { hp:1600, speed:3.8, range:80, cd:{Q:30,W:240,E:360,R:700} }
        };

        // --- ç±» ---
        class Entity {
            constructor(x,y,r,c,team,hp,maxHp) {
                this.x=x; this.y=y; this.r=r; this.c=c; this.team=team;
                this.hp=hp; this.maxHp=maxHp; this.dead=false;
            }
            draw(ctx) {
                // è¡€æ¡
                let pct = this.hp/this.maxHp;
                ctx.fillStyle='#333'; ctx.fillRect(this.x-15, this.y-this.r-8, 30, 4);
                ctx.fillStyle=this.team==='blue'?'#4ecdc4':'#e74c3c'; ctx.fillRect(this.x-15, this.y-this.r-8, 30*pct, 4);
            }
            hit(dmg) {
                if(this.dead) return;
                this.hp-=dmg;
                texts.push({x:this.x, y:this.y-20, val:Math.floor(dmg), life:30});
                if(this.hp<=0) { this.dead=true; this.hp=0; effects.push({x:this.x, y:this.y, r:this.r*2, c:this.c, life:20, type:'boom'}); }
            }
        }

        class Hero extends Entity {
            constructor(x,y,team,type) {
                super(x,y, 20, team==='blue'?'#3498db':'#e74c3c', team, HEROES[type].hp, HEROES[type].hp);
                this.cfg = HEROES[type];
                this.type = type;
                this.cds = {Q:0,W:0,E:0,R:0,AA:0};
                this.face = team==='blue'? -Math.PI/2 : Math.PI/2; // è“é˜Ÿæœä¸Šï¼Œçº¢é˜Ÿæœä¸‹
            }
            update() {
                for(let k in this.cds) if(this.cds[k]>0) this.cds[k]--;
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                // ç®­å¤´
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(this.face)*30, Math.sin(this.face)*30); 
                ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.stroke();
                
                ctx.fillStyle=this.c;
                if(this.type==='mage') { ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.fill(); }
                else if(this.type==='warrior') ctx.fillRect(-15,-15,30,30);
                else { ctx.beginPath();ctx.moveTo(0,-15);ctx.lineTo(12,10);ctx.lineTo(-12,10);ctx.fill(); }
                ctx.restore();
                super.draw(ctx);
            }
        }

        // --- æ ¸å¿ƒï¼šç«–å±åœ°å›¾é€»è¾‘ ---
        // è“å¡”åœ¨åº•éƒ¨(canvas.height - 80)ï¼Œçº¢å¡”åœ¨é¡¶éƒ¨(80)
        function initGame(heroType) {
            document.getElementById('selection-screen').classList.add('hidden');
            resize(); // ç¡®ä¿å°ºå¯¸æ­£ç¡®

            let cx = canvas.width/2;
            let h = canvas.height;

            blueTower = new Entity(cx, h-80, 30, '#3498db', 'blue', 5000, 5000);
            redTower = new Entity(cx, 80, 30, '#e74c3c', 'red', 5000, 5000);
            
            player = new Hero(cx, h-150, 'blue', heroType);
            enemy = new Hero(cx, 150, 'red', 'warrior'); // æ•Œäººé»˜è®¤æˆ˜å£«

            units=[]; bullets=[]; effects=[]; texts=[];
            gameState = 'PLAYING';
            loop();
        }

        function update() {
            if(player.dead) { if(Math.random()<0.01){player.dead=false; player.hp=player.maxHp; player.x=blueTower.x; player.y=blueTower.y;} }
            else {
                player.update();
                // ç©å®¶ç§»åŠ¨
                if(joystick.active) {
                    player.x += joystick.dx * player.cfg.speed;
                    player.y += joystick.dy * player.cfg.speed;
                    player.face = joystick.angle;
                    // è¾¹ç•Œé™åˆ¶
                    player.x = Math.max(20, Math.min(canvas.width-20, player.x));
                    player.y = Math.max(20, Math.min(canvas.height-20, player.y));
                }
                // UI CD
                ['Q','W','E','R'].forEach(k=>{
                    let div = document.getElementById('cd-'+k.toLowerCase());
                    if(player.cds[k]>0) { div.style.display='flex'; div.innerText = Math.ceil(player.cds[k]/60); }
                    else div.style.display='none';
                });
            }

            if(!enemy.dead) {
                enemy.update();
                // ç®€å•AIï¼šç«–å‘è¿›æ”»
                let dist = Math.hypot(player.x-enemy.x, player.y-enemy.y);
                let tx = player.x, ty = player.y;
                
                if(enemy.hp < enemy.maxHp*0.3) { tx=redTower.x; ty=redTower.y; } // æ’¤é€€
                else if(dist > 300) { tx=blueTower.x; ty=blueTower.y; } // æ¨å¡”
                
                let ang = Math.atan2(ty-enemy.y, tx-enemy.x);
                if(Math.hypot(tx-enemy.x, ty-enemy.y)>50) {
                    enemy.x += Math.cos(ang)*2; enemy.y += Math.sin(ang)*2;
                    enemy.face = ang;
                }
                // AI æ”»å‡»
                if(enemy.cds.AA<=0 && dist < 100) {
                    bullets.push({x:enemy.x, y:enemy.y, vx:Math.cos(ang)*6, vy:Math.sin(ang)*6, dmg:30, team:'red', life:30, r:5, c:'red'});
                    enemy.cds.AA = 60;
                }
            } else if(Math.random()<0.01) { enemy.dead=false; enemy.hp=enemy.maxHp; enemy.x=redTower.x; enemy.y=redTower.y; }

            // ç”Ÿæˆå°å…µ (å‚ç›´è·¯çº¿)
            if(!blueTower.dead && Math.random()<0.01) units.push(new Entity(blueTower.x+(Math.random()-0.5)*40, blueTower.y-40, 8, '#4ecdc4', 'blue', 100, 100));
            if(!redTower.dead && Math.random()<0.01) units.push(new Entity(redTower.x+(Math.random()-0.5)*40, redTower.y+40, 8, '#ff6b6b', 'red', 100, 100));

            // å•ä½ç§»åŠ¨
            units.forEach((u,i) => {
                if(u.dead) return;
                let targetY = u.team==='blue' ? 80 : canvas.height-80; // ç›®æ ‡æ˜¯å¯¹æ–¹å¡”Yåæ ‡
                let t = findNearest(u);
                if(t && Math.hypot(t.x-u.x, t.y-u.y)<100) { // é‡åˆ°æ•Œäºº
                     u.x += (t.x-u.x)*0.02; u.y += (t.y-u.y)*0.02;
                     if(Math.random()<0.05) bullets.push({x:u.x, y:u.y, vx:(t.x-u.x)*0.05, vy:(t.y-u.y)*0.05, dmg:10, team:u.team, life:20, r:3, c:u.c});
                } else {
                    u.y += (targetY - u.y > 0 ? 1 : -1) * 1.5; // å‚ç›´è¿›å†›
                    u.x += (canvas.width/2 - u.x) * 0.01; // å‘ä¸­è·¯é æ‹¢
                }
                if(u.dead) units.splice(i,1);
            });

            // å­å¼¹
            bullets.forEach((b,i) => {
                b.x+=b.vx; b.y+=b.vy; b.life--;
                let hit = checkHit(b);
                if(hit) { hit.hit(b.dmg); b.life=0; }
                if(b.life<=0) bullets.splice(i,1);
            });

            // ç‰¹æ•ˆä¸é£˜å­—
            effects.forEach((e,i) => { e.life--; if(e.life<=0) effects.splice(i,1); });
            texts.forEach((t,i) => { t.y-=0.5; t.life--; if(t.life<=0) texts.splice(i,1); });

            // èƒœè´Ÿ
            if(blueTower.hp<=0 || redTower.hp<=0) {
                gameState = 'END';
                document.getElementById('end-screen').classList.remove('hidden');
                document.getElementById('end-msg').innerText = redTower.hp<=0 ? "èƒœåˆ©!" : "å¤±è´¥!";
                document.getElementById('end-msg').style.color = redTower.hp<=0 ? "#28a745" : "#dc3545";
            }
            
            document.getElementById('hp-blue').innerText = Math.floor(blueTower.hp);
            document.getElementById('hp-red').innerText = Math.floor(redTower.hp);
        }

        function draw() {
            ctx.fillStyle = '#161616'; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            // æ²³é“çº¿
            ctx.strokeStyle = '#333'; ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();

            // å¡”
            [blueTower, redTower].forEach(t => {
                if(t.dead) return;
                ctx.fillStyle='#444'; ctx.beginPath(); ctx.arc(t.x,t.y,25,0,Math.PI*2); ctx.fill();
                ctx.fillStyle=t.c; ctx.beginPath(); ctx.arc(t.x,t.y,15,0,Math.PI*2); ctx.fill();
                // å¡”èŒƒå›´
                ctx.strokeStyle=t.team==='blue'?'rgba(0,200,255,0.1)':'rgba(255,0,0,0.1)'; ctx.beginPath(); ctx.arc(t.x,t.y,200,0,Math.PI*2); ctx.stroke();
                t.draw(ctx);
            });

            units.forEach(u => { if(!u.dead) {ctx.fillStyle=u.c; ctx.beginPath(); ctx.arc(u.x,u.y,u.r,0,Math.PI*2); ctx.fill(); u.draw(ctx);} });
            if(!player.dead) player.draw(ctx);
            if(!enemy.dead) enemy.draw(ctx);

            bullets.forEach(b => { ctx.fillStyle=b.c; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); });
            effects.forEach(e => { ctx.fillStyle=e.c; ctx.globalAlpha=e.life/20; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; });
            texts.forEach(t => { ctx.fillStyle='white'; ctx.font='12px Arial'; ctx.fillText(t.val, t.x, t.y); });
        }

        function loop() {
            if(gameState === 'PLAYING') {
                update();
                draw();
                requestAnimationFrame(loop);
            }
        }

        // --- è¾…åŠ©å‡½æ•° ---
        function getTargets(team) {
            let res = [];
            if(team==='blue') { if(!redTower.dead)res.push(redTower); if(!enemy.dead)res.push(enemy); units.forEach(u=>{if(u.team==='red')res.push(u)}); }
            else { if(!blueTower.dead)res.push(blueTower); if(!player.dead)res.push(player); units.forEach(u=>{if(u.team==='blue')res.push(u)}); }
            return res;
        }
        function findNearest(me) {
            let min=9999, res=null;
            getTargets(me.team).forEach(t => { let d=Math.hypot(t.x-me.x, t.y-me.y); if(d<min){min=d; res=t;} });
            return res;
        }
        function checkHit(b) {
            let list = getTargets(b.team);
            for(let t of list) if(Math.hypot(t.x-b.x, t.y-b.y) < t.r+b.r) return t;
            return null;
        }

        // --- è§¦æ‘¸æ§åˆ¶ (å…³é”®ä¿®å¤) ---
        const joyBase = document.getElementById('joystick-base');
        const joyStick = document.getElementById('joystick-stick');
        const joyContainer = document.getElementById('joystick-container');
        let joyStart = {x:0, y:0};

        // æ‘‡æ†äº‹ä»¶ç›‘å¬ (ç»‘å®šåœ¨ container ä¸ŠèŒƒå›´æ›´å¤§)
        joyContainer.addEventListener('touchstart', e => {
            e.preventDefault();
            let t = e.changedTouches[0];
            // è·å– base ä¸­å¿ƒ
            let rect = joyBase.getBoundingClientRect();
            let cx = rect.left + rect.width/2;
            let cy = rect.top + rect.height/2;
            
            joyStart = {x:cx, y:cy};
            joystick.active = true;
            moveStick(t.clientX, t.clientY);
        }, {passive: false});

        joyContainer.addEventListener('touchmove', e => {
            e.preventDefault();
            if(joystick.active) {
                let t = e.changedTouches[0];
                moveStick(t.clientX, t.clientY);
            }
        }, {passive: false});

        function endJoy(e) {
            e.preventDefault();
            joystick.active = false;
            joystick.dx = 0; joystick.dy = 0;
            joyStick.style.transform = `translate(-50%, -50%)`;
        }
        joyContainer.addEventListener('touchend', endJoy);
        joyContainer.addEventListener('touchcancel', endJoy);

        function moveStick(mx, my) {
            let dx = mx - joyStart.x;
            let dy = my - joyStart.y;
            let dist = Math.min(40, Math.hypot(dx, dy)); // åŠå¾„é™åˆ¶
            let ang = Math.atan2(dy, dx);
            
            joystick.dx = Math.cos(ang);
            joystick.dy = Math.sin(ang);
            joystick.angle = ang;
            
            joyStick.style.transform = `translate(calc(-50% + ${joystick.dx*dist}px), calc(-50% + ${joystick.dy*dist}px))`;
        }

        // æŠ€èƒ½äº‹ä»¶
        window.handleSkill = function(e, key) {
            e.preventDefault();
            if(player.dead) return;
            if(key==='AA') { // æ™®æ”»
                let t = findNearest(player);
                if(t && Math.hypot(t.x-player.x, t.y-player.y)<player.cfg.range) {
                    bullets.push({x:player.x, y:player.y, vx:Math.cos(player.face)*8, vy:Math.sin(player.face)*8, dmg:40, team:'blue', life:30, r:5, c:'#fff'});
                } else {
                    // ç©ºæ”¾
                     bullets.push({x:player.x, y:player.y, vx:Math.cos(player.face)*8, vy:Math.sin(player.face)*8, dmg:40, team:'blue', life:20, r:5, c:'#fff'});
                }
                return;
            }
            // æŠ€èƒ½é‡Šæ”¾ (ç®€åŒ–ï¼šè‡ªåŠ¨ç„å‡†æœ€è¿‘æ•Œäººï¼Œæˆ–è€…æœå‘)
            if(player.cds[key]>0) return;
            
            let t = findNearest(player);
            let tx = t ? t.x : player.x + Math.cos(player.face)*200;
            let ty = t ? t.y : player.y + Math.sin(player.face)*200;
            
            // è§†è§‰æ•ˆæœ
            if(key==='Q') bullets.push({x:player.x, y:player.y, vx:Math.cos(Math.atan2(ty-player.y, tx-player.x))*10, vy:Math.sin(Math.atan2(ty-player.y, tx-player.x))*10, dmg:100, team:'blue', life:40, r:10, c:'cyan'});
            if(key==='W') { player.x+=Math.cos(player.face)*100; player.y+=Math.sin(player.face)*100; }
            if(key==='E') effects.push({x:tx, y:ty, r:50, c:'orange', life:20});
            if(key==='R') bullets.push({x:player.x, y:player.y, vx:Math.cos(player.face)*20, vy:Math.sin(player.face)*20, dmg:300, team:'blue', life:50, r:20, c:'purple'});

            player.cds[key] = player.cfg.cd[key];
        };

        window.startGame = function(type) {
            initGame(type);
        }

    </script>
</body>
</html>
