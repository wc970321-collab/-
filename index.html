<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Web MOBA: ÁâπÊïàÂçáÁ∫ßÁâà</title>
    <style>
        * {
            box-sizing: border-box;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000;
            font-family: sans-serif;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* Ê∏∏ÊàèÂå∫ 65% */
        #game-container {
            width: 100%; height: 65%;
            position: relative; background: #101010; border-bottom: 2px solid #333;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* HUD */
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #top-bar { display: flex; justify-content: space-between; padding: 10px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 12px;}
        .team-blue { color: #00eaff; } .team-red { color: #ff4757; }

        /* ÊéßÂà∂Âå∫ 35% */
        #controls-area {
            width: 100%; height: 35%; background-color: #1a1a1a;
            position: relative; display: flex;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        /* ÊëáÊùÜ */
        #joystick-container {
            width: 40%; height: 100%; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        #joystick-base {
            width: 110px; height: 110px; background: rgba(0,0,0,0.4);
            border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; position: relative;
        }
        #joystick-stick {
            width: 40px; height: 40px; background: linear-gradient(135deg, #00eaff, #0099ff);
            border-radius: 50%; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 0 15px rgba(0,234,255,0.5);
        }

        /* ÊäÄËÉΩÂå∫ */
        #skills-container { width: 60%; height: 100%; position: relative; }
        .skill-btn {
            position: absolute; width: 55px; height: 55px; background: #2a2a2a;
            border: 2px solid #444; border-radius: 50%; color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.6);
            font-size: 14px;
        }
        .skill-btn:active { background: #444; transform: scale(0.95); border-color: #888;}
        
        /* Â∏ÉÂ±Ä */
        .p-q { bottom: 20px; right: 130px; border-color: #00eaff; box-shadow: 0 0 10px rgba(0,234,255,0.2);}
        .p-w { bottom: 90px; right: 110px; border-color: #7bed9f; box-shadow: 0 0 10px rgba(123,237,159,0.2);}
        .p-e { bottom: 130px; right: 30px; border-color: #ffa502; box-shadow: 0 0 10px rgba(255,165,2,0.2);}
        .p-r { bottom: 160px; right: 120px; width: 50px!important; height: 50px!important; border-color: #ff4757; background: #300; box-shadow: 0 0 15px rgba(255,71,87,0.4);} 
        .p-aa{ bottom: 20px; right: 20px; width: 80px!important; height: 80px!important; background: #333; font-size: 24px; border-color: #ccc;} 

        .cd-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            border-radius: 50%; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; color: #fff; font-size: 18px;
        }

        /* ÂºπÁ™ó */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 999;
        }
        .hidden { display: none !important; }
        .h-card { width: 90px; padding: 20px; background: #222; border: 1px solid #444; border-radius: 12px; text-align: center; color: white; margin: 10px; transition: 0.2s;}
        .h-card:active { transform: scale(0.95); border-color: #00eaff; }
        h1 { color: #ffd700; margin-bottom: 30px; font-size: 28px; text-transform: uppercase; letter-spacing: 2px; }
        .btn-main { padding: 12px 40px; font-size: 18px; background: linear-gradient(to right, #28a745, #218838); color: white; border: none; border-radius: 25px; margin-top: 20px; box-shadow: 0 5px 15px rgba(40,167,69,0.4);}
    </style>
</head>
<body>

    <div id="selection-screen" class="overlay-screen">
        <h1>ÈÄâÊã©Ëã±ÈõÑ</h1>
        <div style="display:flex;">
            <div class="h-card" onclick="startGame('mage')">
                <div style="font-size:30px; margin-bottom:10px; text-shadow:0 0 10px blue;">üîµ</div>
                <div>Ê≥ïÂ∏à</div>
            </div>
            <div class="h-card" onclick="startGame('shooter')">
                <div style="font-size:30px; margin-bottom:10px; text-shadow:0 0 10px green;">üèπ</div>
                <div>Â∞ÑÊâã</div>
            </div>
            <div class="h-card" onclick="startGame('warrior')">
                <div style="font-size:30px; margin-bottom:10px; text-shadow:0 0 10px red;">üõ°Ô∏è</div>
                <div>ÊàòÂ£´</div>
            </div>
        </div>
    </div>

    <div id="end-screen" class="overlay-screen hidden">
        <h1 id="end-msg">ÁªìÊùü</h1>
        <button class="btn-main" onclick="location.reload()">ËøîÂõûÂ§ßÂéÖ</button>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="hud-layer">
            <div id="top-bar">
                <div onclick="location.reload()" style="font-size:20px;">üè†</div>
                <div class="team-red">ÊïåÂ°î: <span id="hp-red">5000</span></div>
            </div>
            <div style="position:absolute; bottom:10px; left:10px;" class="team-blue">ÊàëÂ°î: <span id="hp-blue">5000</span></div>
        </div>
    </div>

    <div id="controls-area">
        <div id="joystick-container">
            <div id="joystick-base"><div id="joystick-stick"></div></div>
        </div>
        <div id="skills-container">
            <div class="skill-btn p-aa" ontouchstart="handleSkill(event, 'AA')">‚öîÔ∏è</div>
            <div class="skill-btn p-q" ontouchstart="handleSkill(event, 'Q')">Q<div id="cd-q" class="cd-overlay"></div></div>
            <div class="skill-btn p-w" ontouchstart="handleSkill(event, 'W')">W<div id="cd-w" class="cd-overlay"></div></div>
            <div class="skill-btn p-e" ontouchstart="handleSkill(event, 'E')">E<div id="cd-e" class="cd-overlay"></div></div>
            <div class="skill-btn p-r" ontouchstart="handleSkill(event, 'R')">R<div id="cd-r" class="cd-overlay"></div></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('game-container');
        
        function resize() {
            canvas.width = gameContainer.clientWidth;
            canvas.height = gameContainer.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        const CONFIG = {
            speed: { hero: 2.2, minion: 0.8, bullet: 5.0 },
            spawnRate: 600
        };

        const HEROES = {
            mage: { hp:900, speed: 2.0, cd:{Q:40,W:300,E:180,R:600} },
            shooter: { hp:700, speed: 2.2, cd:{Q:20,W:180,E:300,R:900} },
            warrior: { hp:1600, speed: 2.0, cd:{Q:30,W:240,E:360,R:700} }
        };

        let gameState = 'MENU';
        let player, enemy, blueTower, redTower;
        let units=[], bullets=[], effects=[], texts=[], particles=[];
        let joystick = { active:false, dx:0, dy:0, angle: -Math.PI/2 };

        // --- Á≤íÂ≠êÁ≥ªÁªü ---
        class Particle {
            constructor(x, y, color, speed, size) {
                this.x = x; this.y = y; this.color = color;
                let angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(angle) * speed * Math.random();
                this.vy = Math.sin(angle) * speed * Math.random();
                this.life = 1.0;
                this.decay = 0.03 + Math.random() * 0.03;
                this.size = size;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.life -= this.decay;
            }
            draw(ctx) {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        function spawnParticles(x, y, color, count, speed=2, size=2) {
            for(let i=0; i<count; i++) particles.push(new Particle(x, y, color, speed, size));
        }

        // --- ÂÆû‰ΩìÁ±ª ---
        class Entity {
            constructor(x,y,r,c,team,hp,maxHp) {
                this.x=x; this.y=y; this.r=r; this.c=c; this.team=team;
                this.hp=hp; this.maxHp=maxHp; this.dead=false;
            }
            draw(ctx) {
                // Èò¥ÂΩ±
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.beginPath(); ctx.ellipse(this.x, this.y+this.r*0.8, this.r, this.r*0.4, 0, 0, Math.PI*2); ctx.fill();
                
                // Ë°ÄÊù°
                let pct = Math.max(0, this.hp/this.maxHp);
                ctx.fillStyle='#222'; ctx.fillRect(this.x-15, this.y-this.r-12, 30, 5);
                ctx.fillStyle=this.team==='blue'?'#00eaff':'#ff4757'; ctx.fillRect(this.x-15, this.y-this.r-12, 30*pct, 5);
            }
            hit(dmg) {
                if(this.dead) return;
                this.hp-=dmg;
                texts.push({x:this.x, y:this.y-25, val:Math.floor(dmg), life:40});
                if(this.hp<=0) {
                    this.dead=true; this.hp=0;
                    spawnParticles(this.x, this.y, this.c, 15, 3, 3);
                    effects.push({type:'shockwave', x:this.x, y:this.y, r:10, maxR:this.r*2, c:this.c, life:15});
                }
            }
        }

        class Hero extends Entity {
            constructor(x,y,team,type) {
                super(x,y, 18, team==='blue'?'#00eaff':'#ff4757', team, HEROES[type].hp, HEROES[type].hp);
                this.cfg = HEROES[type];
                this.type = type;
                this.cds = {Q:0,W:0,E:0,R:0,AA:0};
                this.face = team==='blue'? -Math.PI/2 : Math.PI/2; 
            }
            update() { for(let k in this.cds) if(this.cds[k]>0) this.cds[k]--; }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                // Ëã±ÈõÑÂÖâÁéØ
                if(this.team==='blue'){
                    ctx.shadowBlur = 15; ctx.shadowColor = "rgba(0, 234, 255, 0.5)";
                }
                
                // ÊúùÂêë
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(this.face)*35, Math.sin(this.face)*35); 
                ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.lineWidth=2; ctx.stroke();
                ctx.shadowBlur=0;

                ctx.fillStyle=this.c;
                if(this.type==='mage') { ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.fill(); }
                else if(this.type==='warrior') { ctx.fillRect(-15,-15,30,30); }
                else { ctx.beginPath();ctx.moveTo(0,-18);ctx.lineTo(14,12);ctx.lineTo(-14,12);ctx.fill(); }
                ctx.restore();
                super.draw(ctx);
            }
        }

        function initGame(heroType) {
            document.getElementById('selection-screen').classList.add('hidden');
            resize();
            let cx = canvas.width/2, h = canvas.height;

            blueTower = {x:cx, y:h-60, r:30, c:'#0099ff', team:'blue', hp:5000, maxHp:5000, dead:false, spawnT:0, atkT:0};
            redTower = {x:cx, y:60, r:30, c:'#ff3333', team:'red', hp:5000, maxHp:5000, dead:false, spawnT:0, atkT:0};
            [blueTower, redTower].forEach(t => { t.draw=Entity.prototype.draw.bind(t); t.hit=Entity.prototype.hit.bind(t); });

            player = new Hero(cx, h-130, 'blue', heroType);
            enemy = new Hero(cx, 130, 'red', 'warrior');

            units=[]; bullets=[]; effects=[]; texts=[]; particles=[];
            gameState = 'PLAYING';
            loop();
        }

        function update() {
            // Áé©ÂÆ∂ÁßªÂä®
            if(!player.dead) {
                player.update();
                if(joystick.active) {
                    player.x += joystick.dx * player.cfg.speed;
                    player.y += joystick.dy * player.cfg.speed;
                    player.face = joystick.angle;
                    player.x = Math.max(15, Math.min(canvas.width-15, player.x));
                    player.y = Math.max(15, Math.min(canvas.height-15, player.y));
                }
                ['Q','W','E','R'].forEach(k=>{
                    let div = document.getElementById('cd-'+k.toLowerCase());
                    if(player.cds[k]>0) { div.style.display='flex'; div.innerText = Math.ceil(player.cds[k]/60); } else div.style.display='none';
                });
            } else if(Math.random()<0.01) {player.dead=false; player.hp=player.maxHp; player.x=blueTower.x; player.y=blueTower.y;}

            // Êïå‰∫∫AI
            if(!enemy.dead) {
                enemy.update();
                let d = Math.hypot(player.x-enemy.x, player.y-enemy.y);
                let tx = blueTower.x, ty = blueTower.y;
                if(enemy.hp<enemy.maxHp*0.3) { tx=redTower.x; ty=redTower.y; }
                else if(d<250) { tx=player.x; ty=player.y; }
                
                let ang = Math.atan2(ty-enemy.y, tx-enemy.x);
                if(Math.hypot(tx-enemy.x, ty-enemy.y)>70) {
                    enemy.x += Math.cos(ang)*enemy.cfg.speed; enemy.y += Math.sin(ang)*enemy.cfg.speed;
                    enemy.face = ang;
                }
                if(enemy.cds.AA<=0 && d < 120) {
                    bullets.push({x:enemy.x, y:enemy.y, vx:Math.cos(ang)*5, vy:Math.sin(ang)*5, dmg:30, team:'red', life:25, r:4, c:'red', style:'basic'});
                    enemy.cds.AA = 90;
                }
            } else if(Math.random()<0.01) {enemy.dead=false; enemy.hp=enemy.maxHp; enemy.x=redTower.x; enemy.y=redTower.y;}

            // Â°î
            [blueTower, redTower].forEach(t => {
                if(t.dead) return;
                t.spawnT++;
                if(t.spawnT > CONFIG.spawnRate) {
                    for(let i=0; i<2; i++) units.push(new Entity(t.x+(i-0.5)*40, t.y + (t.team==='blue'?-50:50), 10, t.team==='blue'?'#7efff5':'#ffcccc', t.team, 120, 120));
                    t.spawnT = 0;
                }
                t.atkT--;
                if(t.atkT <= 0) {
                    let target = findNearest(t, 250);
                    if(target) {
                        let a = Math.atan2(target.y-t.y, target.x-t.x);
                        bullets.push({x:t.x, y:t.y, vx:Math.cos(a)*6, vy:Math.sin(a)*6, dmg:80, team:t.team, life:50, r:6, c:t.c, style:'tower'});
                        t.atkT = 60;
                    }
                }
            });

            // Â∞èÂÖµ
            units.forEach((u,i) => {
                if(u.dead) { units.splice(i,1); return; }
                let t = findNearest(u, 150);
                let tx = u.team==='blue' ? redTower.x : blueTower.x;
                let ty = u.team==='blue' ? redTower.y : blueTower.y;
                
                if(t) {
                    if(Math.hypot(t.x-u.x, t.y-u.y) < 80) {
                        if(Math.random()<0.03) bullets.push({x:u.x, y:u.y, vx:(t.x-u.x)*0.04, vy:(t.y-u.y)*0.04, dmg:10, team:u.team, life:20, r:3, c:u.c, style:'basic'});
                    } else { u.x += (t.x-u.x)*0.015; u.y += (t.y-u.y)*0.015; }
                } else {
                    let ang = Math.atan2(ty-u.y, tx-u.x);
                    u.x += Math.cos(ang) * CONFIG.speed.minion; u.y += Math.sin(ang) * CONFIG.speed.minion;
                }
                // Á¢∞ÊíûÊé®Êå§
                units.forEach(o => {
                    if(u!==o && !o.dead && Math.hypot(u.x-o.x, u.y-o.y)<20) {
                        let a = Math.atan2(u.y-o.y, u.x-o.x);
                        u.x+=Math.cos(a)*0.5; u.y+=Math.sin(a)*0.5;
                    }
                });
            });

            // Â≠êÂºπ
            bullets.forEach((b,i) => {
                b.x+=b.vx; b.y+=b.vy; b.life--;
                // Â∞æËøπÁîüÊàê
                if(b.style === 'fireball' && Math.random()<0.5) particles.push(new Particle(b.x, b.y, 'orange', 0.5, 2));
                if(b.style === 'snipe') particles.push(new Particle(b.x, b.y, '#f0f', 0, 1));

                let t = checkHit(b);
                if(t) { 
                    t.hit(b.dmg); b.life=0; 
                    spawnParticles(b.x, b.y, b.c, 5, 2, 2);
                }
                if(b.life<=0) bullets.splice(i,1);
            });

            // Á≤íÂ≠ê & ÁâπÊïà
            particles.forEach((p,i) => { p.update(); if(p.life<=0) particles.splice(i,1); });
            effects.forEach((e,i) => {
                if(e.type==='area') {
                    e.timer--; if(e.timer<=0 && !e.done) { 
                        e.done=true; dealArea(e.x,e.y,e.r,e.dmg,e.team); 
                        effects.push({type:'shockwave', x:e.x, y:e.y, r:10, maxR:e.r, c:e.c, life:20});
                        spawnParticles(e.x, e.y, e.c, 20, 4, 3);
                    }
                } 
                else if(e.type==='shockwave') { e.r += (e.maxR-e.r)*0.2; }
                
                e.life--; 
                if(e.life<=0 || (e.done && e.type==='area')) if(e.type!=='area'||e.done) effects.splice(i,1);
            });
            texts.forEach((t,i) => {t.y-=0.5; t.life--; if(t.life<=0) texts.splice(i,1);});

            // UI
            document.getElementById('hp-blue').innerText = Math.floor(blueTower.hp);
            document.getElementById('hp-red').innerText = Math.floor(redTower.hp);
            if(blueTower.hp<=0 || redTower.hp<=0) {
                gameState='END'; document.getElementById('end-screen').classList.remove('hidden');
                document.getElementById('end-msg').innerText = redTower.hp<=0?"ËÉúÂà©!":"Â§±Ë¥•!";
                document.getElementById('end-msg').style.color = redTower.hp<=0?"#28a745":"#dc3545";
            }
        }

        function draw() {
            ctx.fillStyle = '#121212'; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            // Âú∞ÊùøÁΩëÊ†º
            ctx.strokeStyle='rgba(255,255,255,0.03)'; ctx.beginPath();
            for(let i=0;i<canvas.width;i+=50){ctx.moveTo(i,0);ctx.lineTo(i,canvas.height);}
            for(let i=0;i<canvas.height;i+=50){ctx.moveTo(0,i);ctx.lineTo(canvas.width,i);}
            ctx.stroke();
            // Ê≤≥ÈÅì
            ctx.strokeStyle='#222'; ctx.lineWidth=5; ctx.beginPath(); ctx.moveTo(0,canvas.height/2); ctx.lineTo(canvas.width,canvas.height/2); ctx.stroke(); ctx.lineWidth=1;

            // Â°î
            [blueTower, redTower].forEach(t => {
                if(t.dead) return;
                ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(t.x,t.y,30,0,Math.PI*2); ctx.fill();
                ctx.shadowBlur=20; ctx.shadowColor=t.c;
                ctx.fillStyle=t.c; ctx.beginPath(); ctx.arc(t.x,t.y,20,0,Math.PI*2); ctx.fill();
                ctx.shadowBlur=0;
                t.draw(ctx);
            });

            units.forEach(u => {if(!u.dead){ctx.fillStyle=u.c; ctx.beginPath(); ctx.arc(u.x,u.y,u.r,0,Math.PI*2); ctx.fill(); u.draw(ctx);}});
            
            // Á≤íÂ≠êÂú®Ëã±ÈõÑ‰∏ãÂ±Ç
            particles.forEach(p => p.draw(ctx));

            if(!player.dead) player.draw(ctx);
            if(!enemy.dead) enemy.draw(ctx);

            // Â≠êÂºπÁªòÂà∂ (ÂèëÂÖâ)
            bullets.forEach(b => {
                ctx.fillStyle=b.c; 
                if(b.style !== 'basic') { ctx.shadowBlur=10; ctx.shadowColor=b.c; }
                ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
                ctx.shadowBlur=0;
            });

            // ÁâπÊïà
            effects.forEach(e => {
                if(e.type==='explode') { ctx.globalAlpha=e.life/20; ctx.fillStyle=e.c; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
                if(e.type==='area' && !e.done) { 
                    ctx.strokeStyle=e.c; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.stroke(); 
                    ctx.fillStyle=e.c; ctx.globalAlpha=0.2; ctx.fill(); ctx.globalAlpha=1;
                    // ËìÑÂäõÂúà
                    ctx.beginPath(); ctx.arc(e.x,e.y,e.r * (1-e.timer/40), 0, Math.PI*2); ctx.strokeStyle='white'; ctx.stroke();
                }
                if(e.type==='shockwave') {
                    ctx.strokeStyle=e.c; ctx.lineWidth=3; ctx.globalAlpha=e.life/20;
                    ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.stroke(); ctx.globalAlpha=1;
                }
                if(e.type==='laser') {
                    ctx.save(); ctx.translate(e.x,e.y); ctx.rotate(e.a);
                    ctx.shadowBlur=20; ctx.shadowColor=e.c;
                    let w = 10 + Math.sin(Date.now()/50)*5;
                    ctx.fillStyle='white'; ctx.fillRect(0,-w/2,600,w);
                    ctx.fillStyle=e.c; ctx.globalAlpha=0.5; ctx.fillRect(0,-w,600,w*2);
                    ctx.restore(); ctx.globalAlpha=1; ctx.shadowBlur=0;
                }
                if(e.type==='slash') {
                    ctx.save(); ctx.translate(e.x,e.y); ctx.rotate(e.a);
                    ctx.strokeStyle='white'; ctx.lineWidth=4; ctx.shadowBlur=10; ctx.shadowColor='white';
                    ctx.beginPath(); ctx.arc(0,0,60,-0.8,0.8); ctx.stroke();
                    ctx.restore(); ctx.shadowBlur=0;
                }
            });

            texts.forEach(t => { ctx.fillStyle='#fff'; ctx.font='bold 14px Arial'; ctx.fillText(t.val, t.x, t.y); });
        }

        function loop() { if(gameState==='PLAYING') { update(); draw(); requestAnimationFrame(loop); } }

        // --- ËæÖÂä© ---
        function getTargets(myTeam) {
            let res=[];
            if(myTeam==='blue') { if(!redTower.dead)res.push(redTower); if(!enemy.dead)res.push(enemy); units.forEach(u=>{if(u.team==='red')res.push(u)}); }
            else { if(!blueTower.dead)res.push(blueTower); if(!player.dead)res.push(player); units.forEach(u=>{if(u.team==='blue')res.push(u)}); }
            return res;
        }
        function findNearest(me, range=9999) {
            let min=range, res=null;
            getTargets(me.team).forEach(t => { let d=Math.hypot(t.x-me.x, t.y-me.y); if(d<min){min=d; res=t;} });
            return res;
        }
        function checkHit(b) {
            for(let t of getTargets(b.team)) if(Math.hypot(t.x-b.x, t.y-b.y) < t.r+b.r) return t;
            return null;
        }
        function dealArea(x,y,r,dmg,team) {
            getTargets(team).forEach(t => { if(Math.hypot(t.x-x, t.y-y) < r+t.r) t.hit(dmg); });
        }

        // --- Ëß¶Êë∏ ---
        const jz = document.getElementById('joystick-container');
        const js = document.getElementById('joystick-stick');
        let jStart={x:0,y:0};
        jz.addEventListener('touchstart', e=>{
            e.preventDefault(); let r=document.getElementById('joystick-base').getBoundingClientRect();
            jStart={x:r.left+r.width/2, y:r.top+r.height/2}; joystick.active=true; moveJoy(e.changedTouches[0]);
        },{passive:false});
        jz.addEventListener('touchmove', e=>{e.preventDefault(); if(joystick.active) moveJoy(e.changedTouches[0]);},{passive:false});
        const endJ=e=>{e.preventDefault(); joystick.active=false; js.style.transform=`translate(-50%,-50%)`;};
        jz.addEventListener('touchend', endJ); jz.addEventListener('touchcancel', endJ);
        function moveJoy(t) {
            let dx=t.clientX-jStart.x, dy=t.clientY-jStart.y;
            let ang=Math.atan2(dy,dx);
            let dist=Math.min(40, Math.hypot(dx,dy));
            joystick.dx=Math.cos(ang); joystick.dy=Math.sin(ang); joystick.angle=ang;
            js.style.transform=`translate(calc(-50% + ${joystick.dx*dist}px), calc(-50% + ${joystick.dy*dist}px))`;
        }

        window.handleSkill = function(e, k) {
            e.preventDefault(); if(player.dead) return;
            
            // AA: Áü≠Ë∑ùÁ¶ªÈùûÊåáÂêëÊÄß
            if(k==='AA') {
                let t = findNearest(player, 300);
                let ang = t ? Math.atan2(t.y-player.y, t.x-player.x) : player.face;
                // ÊôÆÊîªÁîüÂëΩÂë®Êúü 25 * ÈÄüÂ∫¶ 5 = 125ÂÉèÁ¥†Ë∑ùÁ¶ª (ÂéüÊù•ÊòØ250)
                bullets.push({x:player.x, y:player.y, vx:Math.cos(ang)*5, vy:Math.sin(ang)*5, dmg:40, team:'blue', life:25, r:4, c:'#fff', style:'basic'});
                return;
            }

            if(player.cds[k]>0) return;
            let t = findNearest(player, 400);
            let tx = t ? t.x : player.x+Math.cos(player.face)*150;
            let ty = t ? t.y : player.y+Math.sin(player.face)*150;
            let a = Math.atan2(ty-player.y, tx-player.x);

            if(k==='Q') {
                if(player.type==='warrior') {
                    effects.push({type:'slash', x:player.x, y:player.y, a:a, life:15});
                    dealArea(player.x+Math.cos(a)*60, player.y+Math.sin(a)*60, 70, 100, 'blue');
                } else if(player.type==='mage') {
                    // Ê≥ïÂ∏àÁÅ´ÁêÉÁâπÊïà
                    bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*6, vy:Math.sin(a)*6, dmg:120, team:'blue', life:50, r:15, c:'#ffaa00', style:'fireball'});
                } else {
                    bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*8, vy:Math.sin(a)*8, dmg:100, team:'blue', life:40, r:8, c:'#00ff00', style:'basic'});
                }
            }
            if(k==='W') { player.x+=Math.cos(a)*80; player.y+=Math.sin(a)*80; spawnParticles(player.x, player.y, '#fff', 10); }
            if(k==='E') { effects.push({type:'area', x:tx, y:ty, r:60, c:player.type==='mage'?'#00eaff':'orange', dmg:120, team:'blue', timer:40, done:false}); }
            if(k==='R') { 
                if(player.type==='mage') effects.push({type:'laser', x:player.x, y:player.y, a:a, c:'#00eaff', team:'blue', dmg:400, life:25});
                else if(player.type==='shooter') bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*15, vy:Math.sin(a)*15, dmg:400, team:'blue', life:40, r:10, c:'#f0f', style:'snipe'});
                else effects.push({type:'area', x:player.x, y:player.y, r:200, c:'#8B4513', dmg:350, team:'blue', timer:40, done:false});
            }
            player.cds[k] = player.cfg.cd[k];
        };

        window.startGame = function(t) { initGame(t); }
    </script>
</body>
</html>
