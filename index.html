<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Web MOBA: è‹±é›„æŠ€èƒ½é‡åˆ¶ç‰ˆ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ä¿æŒä¸å˜ --- */
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; }
        
        #game-container { width: 100%; height: 65%; position: relative; background: #0d0d0d; border-bottom: 2px solid #333; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* HUD */
        #hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #top-bar { display: flex; justify-content: space-between; padding: 10px 20px; color: white; font-weight: bold; text-shadow: 0 2px 4px black; font-size: 14px;}
        .team-blue { color: #00eaff; } .team-red { color: #ff4757; }

        /* æ§åˆ¶åŒº */
        #controls-area { width: 100%; height: 35%; background-color: #1a1a1a; position: relative; display: flex; box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }
        #joystick-container { width: 40%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
        #joystick-base { width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; position: relative; }
        #joystick-stick { width: 50px; height: 50px; background: linear-gradient(135deg, #ddd, #888); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        /* æŠ€èƒ½æŒ‰é’® */
        #skills-container { width: 60%; height: 100%; position: relative; }
        .skill-btn {
            position: absolute; width: 60px; height: 60px; background: #252525;
            border: 2px solid #444; border-radius: 50%; color: #eee;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; box-shadow: 0 5px 10px rgba(0,0,0,0.5);
            font-size: 16px; transition: transform 0.1s;
        }
        .skill-btn:active { background: #444; transform: scale(0.9); border-color: #aaa;}
        
        /* é’ˆå¯¹ä¸åŒæŠ€èƒ½çš„é¢œè‰²å¾®è°ƒ */
        .p-q { bottom: 20px; right: 140px; border-color: #00eaff; color: #00eaff; }
        .p-w { bottom: 90px; right: 120px; border-color: #7bed9f; color: #7bed9f; }
        .p-e { bottom: 130px; right: 40px; border-color: #ffa502; color: #ffa502; }
        .p-r { bottom: 170px; right: 130px; width: 55px!important; height: 55px!important; border-color: #ff4757; background: #300; color: #ff4757; box-shadow: 0 0 15px rgba(255,71,87,0.4);} 
        .p-aa{ bottom: 20px; right: 20px; width: 85px!important; height: 85px!important; background: #333; font-size: 24px; border-color: #fff; color: white;} 

        .cd-overlay { position: absolute; top:0; left:0; width:100%; height:100%; border-radius: 50%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; color: #fff; font-size: 20px; }

        /* å¼¹çª— */
        .overlay-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; }
        .hidden { display: none !important; }
        .hero-box { display: flex; gap: 15px; margin-top: 20px; }
        .h-card { width: 100px; padding: 20px; background: #222; border: 1px solid #444; border-radius: 12px; text-align: center; color: white; cursor: pointer; transition: 0.2s; }
        .h-card:active { transform: scale(0.95); border-color: white; background: #333; }
        
        h1 { color: #ffd700; font-size: 24px; letter-spacing: 2px; margin-bottom: 10px; }
        p { color: #888; font-size: 12px; margin-bottom: 20px; }
        .desc { font-size: 10px; color: #aaa; margin-top: 5px; line-height: 1.4; }
        .btn-main { padding: 12px 40px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 25px; margin-top: 30px; }
    </style>
</head>
<body>

    <div id="selection-screen" class="overlay-screen">
        <h1>è‹±é›„é€‰æ‹©</h1>
        <p>é€‰æ‹©ä½ çš„æˆ˜æ–—é£æ ¼</p>
        <div class="hero-box">
            <div class="h-card" onclick="startGame('mage')">
                <div style="font-size:35px;">ğŸ§™â€â™‚ï¸</div>
                <div style="color:#00eaff; font-weight:bold;">ç§˜æœ¯æ³•å¸ˆ</div>
                <div class="desc">è¿œç¨‹ / çˆ†å‘<br>å†°éœœä¸æ¿€å…‰</div>
            </div>
            <div class="h-card" onclick="startGame('shooter')">
                <div style="font-size:35px;">ğŸ¹</div>
                <div style="color:#7bed9f; font-weight:bold;">ä¸›æ—å°„æ‰‹</div>
                <div class="desc">è¿œç¨‹ / æ”»é€Ÿ<br>å¤šé‡å°„å‡»</div>
            </div>
            <div class="h-card" onclick="startGame('warrior')">
                <div style="font-size:35px;">âš”ï¸</div>
                <div style="color:#ff4757; font-weight:bold;">ç‹‚æš´æˆ˜å£«</div>
                <div class="desc">è¿‘æˆ˜ / å¦å…‹<br>ç«ç„°æ–©å‡»</div>
            </div>
        </div>
    </div>

    <div id="end-screen" class="overlay-screen hidden">
        <h1 id="end-msg">æ¸¸æˆç»“æŸ</h1>
        <button class="btn-main" onclick="location.reload()">è¿”å›å¤§å…</button>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="hud-layer">
            <div id="top-bar">
                <div onclick="location.reload()" style="font-size:24px;">ğŸ </div>
                <div class="team-red">æ•Œæ–¹åŸºåœ°: <span id="hp-red">5000</span></div>
            </div>
            <div style="position:absolute; bottom:10px; left:20px; font-weight:bold;" class="team-blue">æˆ‘æ–¹åŸºåœ°: <span id="hp-blue">5000</span></div>
        </div>
    </div>

    <div id="controls-area">
        <div id="joystick-container">
            <div id="joystick-base"><div id="joystick-stick"></div></div>
        </div>
        <div id="skills-container">
            <div class="skill-btn p-aa" ontouchstart="handleSkill(event, 'AA')">âš”ï¸</div>
            <div class="skill-btn p-q" ontouchstart="handleSkill(event, 'Q')">Q<div id="cd-q" class="cd-overlay"></div></div>
            <div class="skill-btn p-w" ontouchstart="handleSkill(event, 'W')">W<div id="cd-w" class="cd-overlay"></div></div>
            <div class="skill-btn p-e" ontouchstart="handleSkill(event, 'E')">E<div id="cd-e" class="cd-overlay"></div></div>
            <div class="skill-btn p-r" ontouchstart="handleSkill(event, 'R')">R<div id="cd-r" class="cd-overlay"></div></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('game-container');
        
        function resize() { canvas.width = container.clientWidth; canvas.height = container.clientHeight; }
        window.addEventListener('resize', resize); resize();

        // --- æ¸¸æˆé…ç½® ---
        const CONFIG = { speed: { hero: 2.2, minion: 0.8, bullet: 6.0 }, spawnRate: 600 };

        // è‹±é›„æŠ€èƒ½å‚æ•°å·®å¼‚åŒ–
        const HEROES = {
            mage: { 
                hp: 900, color: '#00eaff', type:'mage', speed: 2.0,
                cd: {Q:50, W:300, E:240, R:800}
            },
            shooter: { 
                hp: 750, color: '#7bed9f', type:'shooter', speed: 2.3,
                cd: {Q:40, W:180, E:360, R:900}
            },
            warrior: { 
                hp: 1800, color: '#ff4757', type:'warrior', speed: 2.1,
                cd: {Q:30, W:240, E:400, R:700}
            }
        };

        let gameState = 'MENU';
        let player, enemy, blueTower, redTower;
        let units=[], bullets=[], effects=[], texts=[], particles=[];
        let joystick = { active:false, dx:0, dy:0, angle: -Math.PI/2 };

        // --- ç²’å­ç³»ç»Ÿ ---
        class Particle {
            constructor(x, y, c, spd, life) {
                this.x = x; this.y = y; this.c = c; this.life = 1.0; this.decay = 1/life;
                let a = Math.random()*Math.PI*2;
                this.vx = Math.cos(a)*spd*Math.random(); this.vy = Math.sin(a)*spd*Math.random();
                this.size = Math.random()*3+1;
            }
            update() { this.x+=this.vx; this.y+=this.vy; this.life-=this.decay; }
            draw(ctx) {
                ctx.globalAlpha = this.life; ctx.fillStyle=this.c; 
                ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        }
        function spawnParticles(x,y,c,n,spd=2) { for(let i=0;i<n;i++) particles.push(new Particle(x,y,c,spd,30)); }

        // --- å®ä½“ç³»ç»Ÿ ---
        class Entity {
            constructor(x,y,r,c,team,hp,maxHp) {
                this.x=x; this.y=y; this.r=r; this.c=c; this.team=team;
                this.hp=hp; this.maxHp=maxHp; this.dead=false;
                this.buffs = []; // e.g., {type:'speed', timer: 20}
            }
            draw(ctx) {
                // é˜´å½±
                ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(this.x, this.y+this.r*0.8, this.r, this.r*0.4, 0, 0, Math.PI*2); ctx.fill();
                // è¡€æ¡
                let pct = Math.max(0, this.hp/this.maxHp);
                ctx.fillStyle='#222'; ctx.fillRect(this.x-15, this.y-this.r-10, 30, 4);
                ctx.fillStyle=this.team==='blue'?'#00eaff':'#ff4757'; ctx.fillRect(this.x-15, this.y-this.r-10, 30*pct, 4);
            }
            hit(dmg) {
                if(this.dead) return;
                this.hp-=dmg;
                texts.push({x:this.x, y:this.y-20, v:Math.floor(dmg), l:30, c:'#fff'});
                if(this.hp<=0) {
                    this.dead=true; this.hp=0;
                    spawnParticles(this.x,this.y,this.c,15,3);
                    effects.push({type:'boom', x:this.x, y:this.y, r:this.r*2, c:this.c, life:15});
                }
            }
        }

        class Hero extends Entity {
            constructor(x,y,team,type) {
                super(x,y,20,HEROES[type].color,team,HEROES[type].hp,HEROES[type].hp);
                this.cfg=HEROES[type]; this.type=type;
                this.cds={Q:0,W:0,E:0,R:0,AA:0};
                this.face=team==='blue'?-Math.PI/2:Math.PI/2;
                this.spinAngle=0; // æˆ˜å£«EæŠ€èƒ½æ—‹è½¬è§’åº¦
            }
            update() {
                for(let k in this.cds) if(this.cds[k]>0) this.cds[k]--;
                // æˆ˜å£«æ—‹é£æ–©é€»è¾‘
                if(this.buffs.find(b=>b.type==='spin')) this.spinAngle+=0.5;
                // Buffè®¡æ—¶
                this.buffs = this.buffs.filter(b => --b.timer > 0);
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                
                // æˆ˜å£«æ—‹é£ç‰¹æ•ˆ
                if(this.buffs.find(b=>b.type==='spin')) {
                    ctx.save(); ctx.rotate(this.spinAngle);
                    ctx.strokeStyle='rgba(255,100,0,0.5)'; ctx.lineWidth=4;
                    ctx.beginPath(); ctx.arc(0,0,60,0,Math.PI*1.5); ctx.stroke();
                    ctx.restore();
                }

                // æœå‘ç®­å¤´
                ctx.rotate(this.face);
                ctx.fillStyle=this.c;
                
                if(this.type==='mage') {
                    // æ³•å¸ˆï¼šåœ†å½¢+æ³•é˜µæ„Ÿ
                    ctx.shadowBlur=10; ctx.shadowColor=this.c;
                    ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill();
                    ctx.strokeStyle='white'; ctx.lineWidth=2; ctx.stroke();
                } else if(this.type==='shooter') {
                    // å°„æ‰‹ï¼šä¸‰è§’å½¢
                    ctx.beginPath(); ctx.moveTo(15,0); ctx.lineTo(-10,10); ctx.lineTo(-10,-10); ctx.fill();
                } else {
                    // æˆ˜å£«ï¼šæ–¹å—/ç›¾ç‰Œ
                    ctx.fillRect(-15,-15,30,30);
                }
                ctx.shadowBlur=0; ctx.restore();
                super.draw(ctx);
            }
        }

        function initGame(heroType) {
            document.getElementById('selection-screen').classList.add('hidden');
            resize();
            let cx=canvas.width/2, h=canvas.height;
            
            blueTower = new Entity(cx, h-60, 30, '#0099ff', 'blue', 5000, 5000);
            redTower = new Entity(cx, 60, 30, '#ff3333', 'red', 5000, 5000);
            
            player = new Hero(cx, h-150, 'blue', heroType);
            enemy = new Hero(cx, 150, 'red', 'warrior'); // æ•Œäººé»˜è®¤æˆ˜å£«
            
            units=[]; bullets=[]; effects=[]; texts=[]; particles=[];
            gameState = 'PLAYING'; loop();
        }

        // --- æ ¸å¿ƒé€»è¾‘æ›´æ–° ---
        function update() {
            if(player.dead && Math.random()<0.01) {player.dead=false;player.hp=player.maxHp;player.x=blueTower.x;player.y=blueTower.y;}
            if(enemy.dead && Math.random()<0.01) {enemy.dead=false;enemy.hp=enemy.maxHp;enemy.x=redTower.x;enemy.y=redTower.y;}

            // ç©å®¶æ§åˆ¶
            if(!player.dead) {
                player.update();
                let speed = player.cfg.speed;
                if(player.buffs.find(b=>b.type==='speed')) speed *= 1.5; // åŠ é€ŸBuff

                if(joystick.active) {
                    player.x += joystick.dx * speed; player.y += joystick.dy * speed;
                    player.face = joystick.angle;
                    player.x = Math.max(20,Math.min(canvas.width-20,player.x));
                    player.y = Math.max(20,Math.min(canvas.height-20,player.y));
                }
                ['Q','W','E','R'].forEach(k=>{
                    let d=document.getElementById('cd-'+k.toLowerCase());
                    if(player.cds[k]>0){d.style.display='flex';d.innerText=Math.ceil(player.cds[k]/60);}else d.style.display='none';
                });
            }

            // æˆ˜å£«æ—‹é£æ–©ä¼¤å®³
            [player, enemy].forEach(h => {
                if(!h.dead && h.buffs.find(b=>b.type==='spin')) {
                    if(Math.random()<0.3) dealArea(h.x, h.y, 60, 5, h.team); // æŒç»­ä¼¤å®³
                    if(Math.random()<0.2) spawnParticles(h.x+(Math.random()-0.5)*40, h.y+(Math.random()-0.5)*40, 'orange', 1);
                }
            });

            // æ•Œäººç®€å•AI
            if(!enemy.dead) {
                enemy.update();
                let t = findNearest(enemy, 400);
                let tx=redTower.x, ty=redTower.y;
                if(t) { tx=t.x; ty=t.y; }
                
                if(Math.hypot(tx-enemy.x, ty-enemy.y)>80) {
                    let a = Math.atan2(ty-enemy.y, tx-enemy.x);
                    enemy.x+=Math.cos(a)*enemy.cfg.speed; enemy.y+=Math.sin(a)*enemy.cfg.speed;
                    enemy.face=a;
                }
                if(t && enemy.cds.AA<=0 && Math.hypot(t.x-enemy.x,t.y-enemy.y)<100) {
                    // æ•Œäººæˆ˜å£«å¹³A
                    effects.push({type:'slash', x:enemy.x, y:enemy.y, a:enemy.face, life:10, c:'red'});
                    t.hit(30);
                    enemy.cds.AA = 80;
                }
            }

            // å¡”ç”Ÿæˆå…µ
            [blueTower, redTower].forEach(t => {
                if(t.dead) return;
                t.spawnT = (t.spawnT||0)+1;
                if(t.spawnT > CONFIG.spawnRate) {
                    for(let i=0; i<2; i++) units.push(new Entity(t.x+(i-0.5)*40, t.y+(t.team==='blue'?-50:50), 10, t.team==='blue'?'#7efff5':'#ffcccc', t.team, 120, 120));
                    t.spawnT=0;
                }
                // å¡”æ”»å‡»
                t.atkT = (t.atkT||0)-1;
                if(t.atkT<=0) {
                    let target = findNearest(t, 250);
                    if(target) {
                        bullets.push({x:t.x, y:t.y, vx:0, vy:0, target:target, speed:6, dmg:80, team:t.team, life:100, style:'tower', c:t.c});
                        t.atkT = 60;
                    }
                }
            });

            // å°å…µé€»è¾‘
            units.forEach((u,i) => {
                if(u.dead){units.splice(i,1); return;}
                let t = findNearest(u, 200);
                let tx = u.team==='blue'?redTower.x:blueTower.x, ty = u.team==='blue'?redTower.y:blueTower.y;
                if(t) {
                    if(Math.hypot(t.x-u.x, t.y-u.y)<100) {
                         if(Math.random()<0.02) bullets.push({x:u.x, y:u.y, target:t, speed:4, dmg:10, team:u.team, life:40, style:'orb', c:u.c});
                    } else { u.x+=(t.x-u.x)*0.015; u.y+=(t.y-u.y)*0.015; }
                } else {
                    let a = Math.atan2(ty-u.y, tx-u.x);
                    u.x+=Math.cos(a)*CONFIG.speed.minion; u.y+=Math.sin(a)*CONFIG.speed.minion;
                }
                // ç¢°æ’
                units.forEach(o=>{ if(u!==o && Math.hypot(u.x-o.x, u.y-o.y)<20){ let a=Math.atan2(u.y-o.y, u.x-o.x); u.x+=Math.cos(a)*0.5; u.y+=Math.sin(a)*0.5; } });
            });

            // å­å¼¹æ›´æ–°
            bullets.forEach((b,i) => {
                if(b.target) { // è¿½è¸ªå¼¹ (å¡”/å°å…µ)
                    let a = Math.atan2(b.target.y-b.y, b.target.x-b.x);
                    b.x+=Math.cos(a)*b.speed; b.y+=Math.sin(a)*b.speed;
                    if(Math.hypot(b.target.x-b.x, b.target.y-b.y)<10) { b.target.hit(b.dmg); b.life=0; }
                } else { // éæŒ‡å‘æ€§ (è‹±é›„)
                    b.x+=b.vx; b.y+=b.vy;
                    let hit = checkHit(b);
                    if(hit) { hit.hit(b.dmg); b.life=0; }
                }
                
                b.life--;
                if(b.life<=0) { bullets.splice(i,1); spawnParticles(b.x, b.y, b.c, 5); }
                // ç²’å­æ‹–å°¾
                if(b.style!=='orb' && Math.random()<0.5) particles.push(new Particle(b.x, b.y, b.c, 0.5, 10));
            });

            particles.forEach((p,i) => { p.update(); if(p.life<=0) particles.splice(i,1); });
            texts.forEach((t,i) => { t.y-=0.5; t.l--; if(t.l<=0) texts.splice(i,1); });
            
            // ç‰¹æ•ˆæ›´æ–°
            effects.forEach((e,i) => {
                e.life--;
                if(e.type==='area') {
                    if(e.life<=0 && !e.done) { // çˆ†ç‚¸æ—¶åˆ»
                        e.done=true; dealArea(e.x, e.y, e.r, e.dmg, e.team);
                        effects.push({type:'boom', x:e.x, y:e.y, r:e.r, c:e.c, life:20});
                        // éœ‡å±æ¨¡æ‹Ÿ (å¯é€‰)
                    }
                }
                if(e.life<=0 && (!e.type==='area' || e.done)) effects.splice(i,1);
            });

            document.getElementById('hp-blue').innerText = Math.floor(blueTower.hp);
            document.getElementById('hp-red').innerText = Math.floor(redTower.hp);
            if(blueTower.hp<=0 || redTower.hp<=0) {
                gameState='END';
                document.getElementById('end-screen').classList.remove('hidden');
            }
        }

        function draw() {
            ctx.fillStyle='#101010'; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            // ç»˜åˆ¶å¡”
            [blueTower, redTower].forEach(t => {
                if(t.dead) return;
                ctx.fillStyle='#333'; ctx.beginPath(); ctx.arc(t.x,t.y,30,0,Math.PI*2); ctx.fill();
                ctx.shadowBlur=20; ctx.shadowColor=t.c;
                ctx.fillStyle=t.c; ctx.beginPath(); ctx.arc(t.x,t.y,20,0,Math.PI*2); ctx.fill();
                ctx.shadowBlur=0;
                t.draw(ctx);
            });

            // ç»˜åˆ¶å•ä½
            units.forEach(u => u.draw(ctx));
            particles.forEach(p => p.draw(ctx));
            if(!player.dead) player.draw(ctx);
            if(!enemy.dead) enemy.draw(ctx);

            // ç»˜åˆ¶å­å¼¹
            bullets.forEach(b => {
                ctx.fillStyle=b.c;
                if(b.style==='fireball' || b.style==='plasma') { ctx.shadowBlur=10; ctx.shadowColor=b.c; }
                
                if(b.style==='arrow') {
                    // ç®­å¤´å½¢å­å¼¹
                    let a = Math.atan2(b.vy, b.vx);
                    ctx.save(); ctx.translate(b.x, b.y); ctx.rotate(a);
                    ctx.beginPath(); ctx.moveTo(5,0); ctx.lineTo(-5,4); ctx.lineTo(-5,-4); ctx.fill();
                    ctx.restore();
                } else {
                    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
                }
                ctx.shadowBlur=0;
            });

            // ç»˜åˆ¶ç‰¹æ•ˆ
            effects.forEach(e => {
                if(e.type==='boom') {
                    ctx.globalAlpha=e.life/20; ctx.fillStyle=e.c; 
                    ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill(); 
                    ctx.globalAlpha=1;
                }
                if(e.type==='slash') {
                    ctx.save(); ctx.translate(e.x,e.y); ctx.rotate(e.a);
                    ctx.strokeStyle=e.c; ctx.lineWidth=4; ctx.shadowBlur=10; ctx.shadowColor=e.c;
                    ctx.beginPath(); ctx.arc(0,0,60,-1.0,1.0); ctx.stroke();
                    ctx.restore();
                }
                if(e.type==='area' && !e.done) {
                    ctx.strokeStyle=e.c; ctx.lineWidth=2;
                    ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.stroke();
                    ctx.fillStyle=e.c; ctx.globalAlpha=0.2; ctx.fill(); ctx.globalAlpha=1;
                    // å€’è®¡æ—¶ç¯
                    ctx.beginPath(); ctx.arc(e.x,e.y,e.r*(e.life/40),0,Math.PI*2); ctx.strokeStyle='white'; ctx.stroke();
                }
                if(e.type==='laser') {
                    ctx.save(); ctx.translate(e.x,e.y); ctx.rotate(e.a);
                    ctx.shadowBlur=20; ctx.shadowColor=e.c;
                    ctx.fillStyle='white'; ctx.fillRect(0,-5,800,10);
                    ctx.fillStyle=e.c; ctx.globalAlpha=0.5; ctx.fillRect(0,-15,800,30);
                    ctx.restore(); ctx.globalAlpha=1; ctx.shadowBlur=0;
                }
                if(e.type==='shadow') { // é—ªç°æ®‹å½±
                    ctx.fillStyle=e.c; ctx.globalAlpha=e.life/20;
                    ctx.beginPath(); ctx.arc(e.x,e.y,20,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
                }
            });

            texts.forEach(t => { ctx.fillStyle=t.c; ctx.font='bold 12px Arial'; ctx.fillText(t.v, t.x, t.y); });
        }

        function loop() { if(gameState==='PLAYING'){update(); draw(); requestAnimationFrame(loop);} }

        // --- è§¦æ‘¸æ§åˆ¶ ---
        const jz = document.getElementById('joystick-container');
        const js = document.getElementById('joystick-stick');
        let jStart={x:0,y:0};
        jz.addEventListener('touchstart', e=>{
            e.preventDefault(); let r=document.getElementById('joystick-base').getBoundingClientRect();
            jStart={x:r.left+r.width/2, y:r.top+r.height/2}; joystick.active=true; moveJoy(e.changedTouches[0]);
        },{passive:false});
        jz.addEventListener('touchmove', e=>{e.preventDefault(); if(joystick.active) moveJoy(e.changedTouches[0]);}, {passive:false});
        const endJ=e=>{e.preventDefault(); joystick.active=false; js.style.transform=`translate(-50%,-50%)`;};
        jz.addEventListener('touchend', endJ); jz.addEventListener('touchcancel', endJ);

        function moveJoy(t) {
            let dx=t.clientX-jStart.x, dy=t.clientY-jStart.y;
            let ang=Math.atan2(dy,dx);
            let dist=Math.min(40, Math.hypot(dx,dy));
            joystick.dx=Math.cos(ang); joystick.dy=Math.sin(ang); joystick.angle=ang;
            js.style.transform=`translate(calc(-50% + ${joystick.dx*dist}px), calc(-50% + ${joystick.dy*dist}px))`;
        }

        window.handleSkill = function(e, k) {
            e.preventDefault(); if(player.dead) return;

            // æ™®æ”» (AA)
            if(k==='AA') {
                if(player.cds.AA > 0) return;
                let t = findNearest(player, 250);
                let ang = t ? Math.atan2(t.y-player.y, t.x-player.x) : player.face;
                // æ™®æ”»è·ç¦»ç¼©çŸ­ (life=15, speed=10 => 150px)
                let pType = player.type==='shooter'?'arrow':'orb';
                bullets.push({x:player.x, y:player.y, vx:Math.cos(ang)*10, vy:Math.sin(ang)*10, dmg:40, team:'blue', life:15, r:5, c:'white', style:pType});
                player.cds.AA = 30; // 0.5ç§’é—´éš”
                return;
            }

            if(player.cds[k]>0) return;
            let t = findNearest(player, 400);
            let tx = t ? t.x : player.x+Math.cos(player.face)*150;
            let ty = t ? t.y : player.y+Math.sin(player.face)*150;
            let a = Math.atan2(ty-player.y, tx-player.x);

            // === æ³•å¸ˆæŠ€èƒ½ ===
            if(player.type === 'mage') {
                if(k==='Q') { // å¯’å†°ç®­
                    bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*8, vy:Math.sin(a)*8, dmg:120, team:'blue', life:60, r:12, c:'#00eaff', style:'fireball'});
                }
                if(k==='W') { // é—ªç°
                    effects.push({type:'shadow', x:player.x, y:player.y, c:'#00eaff', life:20});
                    player.x += Math.cos(a)*120; player.y += Math.sin(a)*120;
                    effects.push({type:'boom', x:player.x, y:player.y, r:30, c:'#00eaff', life:10});
                }
                if(k==='E') { // æš´é£é›ª
                    effects.push({type:'area', x:tx, y:ty, r:80, c:'#00eaff', dmg:150, team:'blue', life:60});
                }
                if(k==='R') { // æ¿€å…‰
                    effects.push({type:'laser', x:player.x, y:player.y, a:a, c:'#a300ff', team:'blue', dmg:500, life:20});
                }
            } 
            // === å°„æ‰‹æŠ€èƒ½ ===
            else if(player.type === 'shooter') {
                if(k==='Q') { // ä¸‰é‡å°„å‡»
                    for(let i=-1; i<=1; i++) {
                        let ang = a + i*0.3;
                        bullets.push({x:player.x, y:player.y, vx:Math.cos(ang)*12, vy:Math.sin(ang)*12, dmg:60, team:'blue', life:30, r:4, c:'#7bed9f', style:'plasma'});
                    }
                }
                if(k==='W') { // ç¿»æ»š
                    player.x += Math.cos(a)*100; player.y += Math.sin(a)*100;
                    player.buffs.push({type:'speed', timer:60}); // åŠ é€Ÿbuff
                }
                if(k==='E') { // æ‰‹é›·
                    effects.push({type:'area', x:tx, y:ty, r:60, c:'orange', dmg:180, team:'blue', life:40});
                }
                if(k==='R') { // ç‹™å‡»
                    bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*25, vy:Math.sin(a)*25, dmg:400, team:'blue', life:60, r:6, c:'red', style:'plasma'});
                }
            }
            // === æˆ˜å£«æŠ€èƒ½ ===
            else if(player.type === 'warrior') {
                if(k==='Q') { // çƒˆç«æ–©
                    effects.push({type:'slash', x:player.x, y:player.y, a:a, c:'#ff4757', life:15});
                    dealArea(player.x+Math.cos(a)*50, player.y+Math.sin(a)*50, 80, 100, 'blue');
                }
                if(k==='W') { // å†²é”‹
                    let dashFrame = 0;
                    let dashId = setInterval(()=>{
                        player.x+=Math.cos(a)*15; player.y+=Math.sin(a)*15;
                        dealArea(player.x, player.y, 30, 20, 'blue');
                        dashFrame++;
                        if(dashFrame>10) clearInterval(dashId);
                    }, 16);
                }
                if(k==='E') { // å‰‘åˆƒé£æš´
                    player.buffs.push({type:'spin', timer:180}); // æŒç»­3ç§’
                }
                if(k==='R') { // å´©å±±å‡»
                    player.x = tx; player.y = ty; // è·³è·ƒ
                    effects.push({type:'boom', x:tx, y:ty, r:120, c:'#ff4757', life:20});
                    dealArea(tx, ty, 120, 300, 'blue');
                }
            }

            player.cds[k] = player.cfg.cd[k];
        };

        // --- è¾…åŠ© ---
        function getTargets(myTeam) {
            let res=[];
            if(myTeam==='blue') { if(!redTower.dead)res.push(redTower); if(!enemy.dead)res.push(enemy); units.forEach(u=>{if(u.team==='red')res.push(u)}); }
            else { if(!blueTower.dead)res.push(blueTower); if(!player.dead)res.push(player); units.forEach(u=>{if(u.team==='blue')res.push(u)}); }
            return res;
        }
        function findNearest(me, range) {
            let min=range, res=null;
            getTargets(me.team).forEach(t => { let d=Math.hypot(t.x-me.x, t.y-me.y); if(d<min){min=d; res=t;} });
            return res;
        }
        function checkHit(b) { for(let t of getTargets(b.team)) if(Math.hypot(t.x-b.x, t.y-b.y) < t.r+b.r) return t; return null; }
        function dealArea(x,y,r,dmg,team) { getTargets(team).forEach(t => { if(Math.hypot(t.x-x, t.y-y) < r+t.r) t.hit(dmg); }); }

        window.startGame = function(t) { initGame(t); }
    </script>
</body>
</html>
