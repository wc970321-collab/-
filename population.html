<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸­å›½äººå£ç»“æ„æ¨æ¼” 2025 (ç§»åŠ¨é€‚é…ç‰ˆ)</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4338ca;      /* é›è“ */
            --primary-light: #6366f1;
            --male: #3b82f6;
            --female: #f43f5e;
            --bg-grad: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --text-main: #111827;
            --text-sub: #6b7280;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-grad);
            color: var(--text-main);
            min-height: 100vh;
        }

        /* å¸ƒå±€å®¹å™¨ */
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 340px 1fr; /* PCç«¯å·¦ä¾§å›ºå®šå®½åº¦ */
            gap: 24px;
            align-items: start;
        }

        /* ------ å·¦ä¾§æ§åˆ¶æ  ------ */
        .sidebar {
            background: var(--glass);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .header-area { margin-bottom: 24px; text-align: left; }
        
        h1 {
            font-size: 1.4rem;
            margin: 0 0 8px 0;
            background: linear-gradient(45deg, var(--primary), var(--female));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .subtitle { font-size: 0.85rem; color: var(--text-sub); line-height: 1.4; }

        /* æ§ä»¶æ ·å¼ */
        .control-group { margin-bottom: 24px; }
        
        .label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .label-title { font-weight: 600; font-size: 0.95rem; color: var(--text-main); }
        .label-val { 
            font-family: 'Monaco', monospace; 
            color: var(--primary); 
            font-weight: 700; 
            font-size: 1.1rem; 
            background: rgba(99, 102, 241, 0.1);
            padding: 2px 8px;
            border-radius: 6px;
        }

        /* ä¼˜åŒ–æ»‘å—è§¦æ‘¸ä½“éªŒ */
        .range-wrap {
            padding: 5px 0; /* å¢åŠ ä¸Šä¸‹è§¦æ‘¸åŒºåŸŸ */
        }
        input[type=range] {
            width: 100%;
            height: 6px;
            background: #d1d5db;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px; /* æ›´å¤§çš„è§¦æ‘¸ç‚¹ */
            height: 24px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.1); background: var(--primary); }

        .btn-group { display: flex; gap: 12px; margin-top: 16px; }
        
        button {
            flex: 1;
            padding: 12px; /* æ›´å¤§çš„ç‚¹å‡»åŒºåŸŸ */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .btn-play { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(67, 56, 202, 0.2); }
        .btn-play:active { background: var(--primary-light); }
        .btn-reset { background: #f3f4f6; color: var(--text-main); border: 1px solid #e5e7eb; }

        .personal-card {
            background: linear-gradient(135deg, #eff6ff 0%, #fff 100%);
            border: 1px solid #bfdbfe;
            border-radius: var(--radius);
            padding: 16px;
        }
        .personal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 1rem;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
        }

        /* ------ å³ä¾§å†…å®¹åŒº ------ */
        .main-view { display: flex; flex-direction: column; gap: 24px; }

        /* KPI çŸ©é˜µ */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }
        .kpi-card {
            background: white;
            padding: 16px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
        }
        .kpi-icon { font-size: 1.2rem; color: var(--primary-light); margin-bottom: 6px; opacity: 0.8; }
        .kpi-num { font-size: 1.4rem; font-weight: 800; color: var(--text-main); line-height: 1.2; }
        .kpi-desc { font-size: 0.75rem; color: var(--text-sub); margin-top: 4px; }
        
        .alert-safe { color: #10b981; }
        .alert-warn { color: #f59e0b; }
        .alert-danger { color: #ef4444; }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-box {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        .chart-header {
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 12px;
            margin-bottom: 12px;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #mainPyramid { width: 100%; height: 500px; }
        
        .trend-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        .mini-chart { width: 100%; height: 200px; }

        /* ============================
           ğŸ“± ç§»åŠ¨ç«¯è‡ªé€‚åº” (Media Queries)
           ============================ */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr; /* å•æ å¸ƒå±€ */
                padding: 12px;
                gap: 20px;
            }

            .sidebar {
                position: static; /* ç§»åŠ¨ç«¯ä¸éœ€è¦å¸é¡¶ï¼Œå¤ªå ç©ºé—´ */
                padding: 20px;
            }

            h1 { font-size: 1.3rem; text-align: center; }
            .subtitle { text-align: center; margin-bottom: 15px; }

            /* KPI å˜ä¸º 2x2 */
            .kpi-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            /* ä¸»å›¾è¡¨é«˜åº¦é€‚åº”å±å¹• */
            #mainPyramid { height: 400px; }

            /* è¶‹åŠ¿å›¾å˜ä¸ºå‚ç›´æ’åˆ— */
            .trend-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            /* è°ƒæ•´å›¾è¡¨å†…è¾¹è· */
            .chart-box { padding: 15px; }
        }

        /* é’ˆå¯¹è¶…å°å±å¹• (iPhone SEç­‰) */
        @media (max-width: 380px) {
            .kpi-num { font-size: 1.2rem; }
            #mainPyramid { height: 350px; }
        }
    </style>
</head>
<body>

<div class="dashboard">
    <!-- å·¦ä¾§/é¡¶éƒ¨ æ§åˆ¶åŒº -->
    <div class="sidebar">
        <div class="header-area">
            <h1>ğŸ‡¨ğŸ‡³ äººå£æ¨æ¼” Cockpit</h1>
            <div class="subtitle">2025-2100 æ·±åº¦æ¨æ¼”<br>åŸºäºæœ€æ–°äººå£æ•°æ®ä¿®æ­£æ¨¡å‹</div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <span class="label-title"><i class="fa-regular fa-calendar-days"></i> å¹´ä»½</span>
                <span class="label-val" id="uiYear">2025</span>
            </div>
            <div class="range-wrap">
                <input type="range" id="yearSlider" min="1990" max="2100" value="2025" step="1">
            </div>
            <div class="btn-group">
                <button class="btn-play" id="btnPlay"><i class="fa-solid fa-play"></i> æ’­æ”¾æ¼”ç¤º</button>
                <button class="btn-reset" onclick="resetSim()">é‡ç½®</button>
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <span class="label-title"><i class="fa-solid fa-baby-carriage"></i> ç”Ÿè‚²ç‡ (TFR)</span>
                <span class="label-val" id="uiTfr">1.0</span>
            </div>
            <div class="range-wrap">
                <input type="range" id="tfrSlider" min="0.6" max="2.0" value="1.0" step="0.1">
            </div>
            <div style="font-size:0.75rem; color:#6b7280; margin-top:8px; display:flex; justify-content:space-between;">
                <span>0.7 (æä½)</span>
                <span>1.0 (ç°çŠ¶)</span>
                <span>1.5 (å›æš–)</span>
            </div>
        </div>

        <div class="personal-card">
            <div class="label-title" style="margin-bottom:8px;">ğŸ‘¤ ä¸ªäººå‘½è¿æ˜ å°„</div>
            <div style="font-size:0.85rem; color:#666;">è¾“å…¥ä½ çš„å‡ºç”Ÿå¹´ä»½:</div>
            <input type="number" id="userBirth" class="personal-input" value="1990" pattern="\d*">
            <div id="personalReport" style="margin-top:12px; font-size:0.9rem; line-height:1.5; color:#374151;">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>

    <!-- å³ä¾§/ä¸‹æ–¹ å±•ç¤ºåŒº -->
    <div class="main-view">
        <!-- 4ä¸ªæ ¸å¿ƒæŒ‡æ ‡ -->
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-icon"><i class="fa-solid fa-users"></i></div>
                <div class="kpi-num" id="kpiTotal">--</div>
                <div class="kpi-desc">æ€»äººå£ (äº¿)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon"><i class="fa-solid fa-scale-unbalanced"></i></div>
                <div class="kpi-num" id="kpiSupport">--</div>
                <div class="kpi-desc">æŠšå…»æ¯” (åŠ³:è€)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon"><i class="fa-solid fa-hourglass-half"></i></div>
                <div class="kpi-num" id="kpiMedian">--</div>
                <div class="kpi-desc">ä¸­ä½å¹´é¾„ (å²)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon"><i class="fa-solid fa-cane"></i></div>
                <div class="kpi-num" id="kpiElder">--</div>
                <div class="kpi-desc">65å²+ å æ¯”</div>
            </div>
        </div>

        <!-- äººå£é‡‘å­—å¡” -->
        <div class="chart-box">
            <div class="chart-header">
                <i class="fa-solid fa-chart-column" style="color:var(--primary)"></i>
                <span>äººå£ç»“æ„é‡‘å­—å¡” (å·¦ç”·/å³å¥³)</span>
            </div>
            <div id="mainPyramid"></div>
        </div>

        <!-- è¡Œä¸šè¶‹åŠ¿ -->
        <div class="trend-grid">
            <div class="chart-box">
                <div class="chart-header">
                    <span style="font-size:0.9rem">ğŸ“ å¹¼æ•™/å°å­¦ (0-12å²)</span>
                </div>
                <div id="chartKids" class="mini-chart"></div>
            </div>
            <div class="chart-box">
                <div class="chart-header">
                    <span style="font-size:0.9rem">ğŸ  åˆšéœ€è´­æˆ¿ (25-34å²)</span>
                </div>
                <div id="chartHouse" class="mini-chart"></div>
            </div>
            <div class="chart-box">
                <div class="chart-header">
                    <span style="font-size:0.9rem">ğŸ¥ æ·±åº¦åŒ»å…» (80å²+)</span>
                </div>
                <div id="chartElder" class="mini-chart"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. æ•°æ®æ¨¡å‹ (ä¸ä¹‹å‰ä¿æŒä¸€è‡´ï¼Œæ ¸å¿ƒç®—æ³•) ---
    const historicalBirths = {
        1949:1275,1950:1419,1951:1349,1952:1622,1953:1637,1954:2232,1955:1965,1956:1961,1957:2138,1958:1889,
        1959:1635,1960:1402,1961:949,1962:2451,1963:2934,1964:2721,1965:2679,1966:2554,1967:2543,1968:2731,
        1969:2707,1970:2733,1971:2551,1972:2550,1973:2447,1974:2463,1975:2243,1976:2031,1977:1765,1978:1725,
        1979:1715,1980:1776,1981:2064,1982:2230,1983:2052,1984:2050,1985:2190,1986:2374,1987:2508,1988:2445,
        1989:2396,1990:2374,1991:2250,1992:2113,1993:2119,1994:2098,1995:2052,1996:2057,1997:2028,1998:1934,
        1999:1827,2000:1765,2001:1696,2002:1641,2003:1593,2004:1588,2005:1612,2006:1581,2007:1591,2008:1604,
        2009:1587,2010:1588,2011:1600,2012:1635,2013:1640,2014:1687,2015:1655,2016:1786,2017:1723,2018:1523,
        2019:1465,2020:1200,2021:1062,2022:956,2023:902
    };

    function getBirths(year, tfr) {
        if (historicalBirths[year]) return historicalBirths[year];
        if (year < 1949) return 1100;
        const lastKnown = historicalBirths[2023]; 
        const diff = year - 2023;
        const declineRate = 0.975; 
        const tfrFactor = 1 + (tfr - 1.05) * 0.08;
        return Math.max(lastKnown * Math.pow(declineRate * tfrFactor, diff), 200);
    }

    function getSurvivalRate(age, birthYear, sex) {
        if (age < 0) return 1;
        if (age > 110) return 0;
        let penalty = birthYear < 1960 ? (1960 - birthYear) * 0.003 : 0;
        let effectiveAge = sex === 'female' ? age - 4.5 : age;
        let survival = 1;
        if (effectiveAge <= 50) survival = 0.99 - (effectiveAge * 0.0004); 
        else if (effectiveAge <= 70) survival = 0.97 - Math.pow((effectiveAge - 50), 1.8) * 0.0006;
        else survival = 0.85 - Math.pow((effectiveAge - 70), 2.2) * 0.0015;
        return Math.max(0, survival * (1 - penalty));
    }

    function calculateData(year, tfr) {
        let maleArr = [], femaleArr = [], totalPop = 0;
        let stats = { kids:0, house:0, labor:0, elder:0, deepElder:0 };
        let ageDist = [];

        for (let age = 0; age <= 105; age++) {
            let bYear = year - age;
            let births = getBirths(bYear, tfr);
            // ç®€å•çš„æ€§åˆ«æ¯”æ¨¡æ‹Ÿ
            let ratio = (bYear>=1980 && bYear<=2020) ? (1.18 - Math.abs(bYear-2005)*0.003) : 1.07;
            
            let mPop = Math.floor(births * (ratio/(1+ratio)) * getSurvivalRate(age, bYear, 'male'));
            let fPop = Math.floor(births * (1/(1+ratio)) * getSurvivalRate(age, bYear, 'female'));
            let sum = mPop + fPop;

            maleArr.push(-mPop);
            femaleArr.push(fPop);
            totalPop += sum;
            
            if (age <= 12) stats.kids += sum;
            if (age >= 25 && age <= 34) stats.house += sum;
            if (age >= 15 && age <= 64) stats.labor += sum;
            if (age >= 65) stats.elder += sum;
            if (age >= 80) stats.deepElder += sum;
            ageDist.push({age, count: sum});
        }

        let mid = totalPop/2, acc=0, median=0;
        for(let item of ageDist){ acc+=item.count; if(acc>=mid){ median=item.age; break;}}

        return {
            year, maleArr, femaleArr,
            total: (totalPop/10000).toFixed(2),
            supportRatio: stats.elder>0 ? (stats.labor/stats.elder).toFixed(2) : 'âˆ',
            median,
            elderRate: ((stats.elder/totalPop)*100).toFixed(1),
            valKids: Math.round(stats.kids),
            valHouse: Math.round(stats.house),
            valDeepElder: Math.round(stats.deepElder)
        };
    }

    // --- 2. å›¾è¡¨åˆå§‹åŒ–ä¸è‡ªé€‚åº” ---
    const chartMain = echarts.init(document.getElementById('mainPyramid'));
    const chartKids = echarts.init(document.getElementById('chartKids'));
    const chartHouse = echarts.init(document.getElementById('chartHouse'));
    const chartElder = echarts.init(document.getElementById('chartElder'));
    
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜ (è§£å†³æ¨ªå±ç«–å±åˆ‡æ¢é—®é¢˜)
    window.addEventListener('resize', () => {
        chartMain.resize();
        chartKids.resize();
        chartHouse.resize();
        chartElder.resize();
    });

    let trendCache = null;

    function renderCharts(data, tfr) {
        // ä¸»å›¾
        chartMain.setOption({
            tooltip: { trigger: 'axis', formatter: (p) => `${p[0].name}å²<br>ç”·:${Math.abs(p[0].value)}ä¸‡ å¥³:${p[1].value}ä¸‡` },
            grid: { top: 30, bottom: 25, left: 5, right: 5, containLabel: true },
            xAxis: { 
                type: 'value', min:-1500, max:1500, 
                axisLabel: { formatter: v=>Math.abs(v), fontSize: 10 },
                splitLine: { lineStyle:{type:'dashed', color:'#eee'} }
            },
            yAxis: { type: 'category', data: Array.from({length:106},(_,i)=>i), axisTick:{show:false} },
            series: [
                { name:'ç”·', type:'bar', stack:'t', data:data.maleArr, itemStyle:{color:'#3b82f6', borderRadius:[3,0,0,3]} },
                { name:'å¥³', type:'bar', stack:'t', data:data.femaleArr, itemStyle:{color:'#f43f5e', borderRadius:[0,3,3,0]} }
            ],
            animationDurationUpdate: 200
        });

        // è¶‹åŠ¿å›¾ (å¸¦ç¼“å­˜)
        if (!trendCache || trendCache.tfr !== tfr) {
            let years=[], dK=[], dH=[], dE=[];
            for(let y=1990; y<=2080; y++){
                let r = calculateData(y, tfr);
                years.push(y); dK.push(r.valKids); dH.push(r.valHouse); dE.push(r.valDeepElder);
            }
            trendCache = {tfr, years, dK, dH, dE};
        }

        const miniOpt = (data, color, currY) => ({
            tooltip: { trigger: 'axis' },
            grid: { top:10, bottom:10, left:0, right:0 },
            xAxis: { type:'category', data:trendCache.years, show:false },
            yAxis: { type:'value', show:false },
            series: [{
                type:'line', data, showSymbol:false, smooth:true,
                lineStyle:{width:3, color},
                areaStyle:{color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color},{offset:1,color:'#fff'}],false), opacity:0.2},
                markLine: {
                    symbol:'none', label:{show:false},
                    data:[{xAxis: currY-1990}],
                    lineStyle:{color:'#333', type:'dashed'}
                }
            }]
        });

        chartKids.setOption(miniOpt(trendCache.dK, '#10b981', data.year));
        chartHouse.setOption(miniOpt(trendCache.dH, '#6366f1', data.year));
        chartElder.setOption(miniOpt(trendCache.dE, '#f59e0b', data.year));
    }

    // --- 3. äº¤äº’é€»è¾‘ ---
    const els = {
        year: document.getElementById('yearSlider'),
        tfr: document.getElementById('tfrSlider'),
        birth: document.getElementById('userBirth'),
        btnPlay: document.getElementById('btnPlay'),
        uiYear: document.getElementById('uiYear'),
        uiTfr: document.getElementById('uiTfr'),
        kpiTotal: document.getElementById('kpiTotal'),
        kpiSupport: document.getElementById('kpiSupport'),
        kpiMedian: document.getElementById('kpiMedian'),
        kpiElder: document.getElementById('kpiElder'),
        report: document.getElementById('personalReport')
    };

    function update() {
        const y = parseInt(els.year.value);
        const tfr = parseFloat(els.tfr.value);
        
        els.uiYear.innerText = y;
        els.uiTfr.innerText = tfr.toFixed(1);
        
        const data = calculateData(y, tfr);
        
        els.kpiTotal.innerText = data.total;
        els.kpiSupport.innerText = data.supportRatio;
        els.kpiSupport.className = 'kpi-num ' + (data.supportRatio<2 ? 'alert-danger' : (data.supportRatio<3?'alert-warn':'alert-safe'));
        els.kpiMedian.innerText = data.median;
        els.kpiElder.innerText = data.elderRate + '%';
        
        // ä¸ªäººæŠ¥å‘Š
        const birth = parseInt(els.birth.value);
        const age = y - birth;
        const retire = birth + 60;
        let html = `ä»Šå¹´ <b>${age}</b> å²`;
        if(age < 0) html = `è·å‡ºç”Ÿè¿˜æœ‰ ${-age} å¹´`;
        else if(y >= retire) html += ` (å·²é€€ä¼‘)ã€‚<br>æ¯ <b>${data.supportRatio}</b> ä¸ªåŠ³åŠ¨åŠ›å…»ä¸€ä¸ªè€äººã€‚`;
        else html += `ã€‚<br>è·é€€ä¼‘è¿˜æœ‰ ${retire-y} å¹´ï¼Œå±Šæ—¶è€é¾„åŒ–ç‡çº¦ <b>${calculateData(retire, tfr).elderRate}%</b>ã€‚`;
        els.report.innerHTML = html;

        renderCharts(data, tfr);
    }

    // æ’­æ”¾åŠŸèƒ½
    let timer;
    els.btnPlay.addEventListener('click', () => {
        if(timer) {
            clearInterval(timer); timer = null;
            els.btnPlay.innerHTML = '<i class="fa-solid fa-play"></i> æ’­æ”¾æ¼”ç¤º';
        } else {
            els.btnPlay.innerHTML = '<i class="fa-solid fa-pause"></i> æš‚åœæ’­æ”¾';
            timer = setInterval(() => {
                let v = parseInt(els.year.value);
                if(v >= 2100) { clearInterval(timer); return; }
                els.year.value = v + 1;
                update();
            }, 150);
        }
    });

    function resetSim() {
        if(timer) els.btnPlay.click(); // stop
        els.year.value = 2025;
        els.tfr.value = 1.0;
        update();
    }

    [els.year, els.tfr, els.birth].forEach(el => el.addEventListener('input', update));
    
    // å¯åŠ¨
    update();

</script>
</body>
</html>
