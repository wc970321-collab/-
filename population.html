<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½äººå£ç»“æ„æ·±åº¦æ¨æ¼”ç³»ç»Ÿ (ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --male-color: #5b8ff9;
            --female-color: #e8684a;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
        }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* å¤´éƒ¨ä¸æ§åˆ¶åŒº */
        header {
            text-align: center;
            margin-bottom: 25px;
        }
        h1 { margin: 0 0 10px 0; color: #1f1f1f; }
        .subtitle { color: #666; font-size: 0.95em; }

        .control-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
            align-items: center;
        }

        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1f1f1f;
        }
        .control-group .desc {
            font-size: 0.8em;
            color: #888;
            margin-top: 4px;
        }

        /* æ»‘å—æ ·å¼ */
        input[type=range] {
            width: 100%;
            cursor: pointer;
            height: 6px;
            background: #e1e1e1;
            border-radius: 3px;
            appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #1890ff;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        .value-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #1890ff;
            font-family: monospace;
        }

        /* æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ */
        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .kpi-val { font-size: 1.4em; font-weight: bold; color: #333; margin: 5px 0; }
        .kpi-label { font-size: 0.85em; color: #666; }
        .kpi-note { font-size: 0.75em; color: #999; }
        
        .alert-high { color: #cf1322; }
        .alert-mid { color: #d46b08; }
        .alert-safe { color: #389e0d; }

        /* ä¸»å›¾è¡¨åŒº */
        .main-chart-wrapper {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            height: 550px;
        }
        #mainPyramid { width: 100%; height: 100%; }

        /* è¡Œä¸šè¶‹åŠ¿å°å›¾è¡¨ */
        .trend-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .trend-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .trend-title { font-weight: bold; font-size: 0.9em; margin-bottom: 10px; text-align: center; }
        .mini-chart { width: 100%; height: 200px; }

        /* ä¸ªäººå‘½è¿æ¿å— */
        .personal-insight {
            background: linear-gradient(135deg, #e6f7ff 0%, #ffffff 100%);
            border: 1px solid #91d5ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        .input-group input {
            padding: 8px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-top: 5px;
        }
        .insight-text {
            flex-grow: 1;
            font-size: 0.95em;
            line-height: 1.6;
            color: #0050b3;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .control-panel, .kpi-dashboard, .trend-section, .personal-insight {
                grid-template-columns: 1fr;
                display: grid; /* override flex */
            }
            .personal-insight { display: block; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ä¸­å›½äººå£ç»“æ„æ·±åº¦æ¨æ¼”ç³»ç»Ÿ (ä¿®å¤ç‰ˆ)</h1>
        <div class="subtitle">é›†æˆ TFR è°ƒèŠ‚ã€æ€§åˆ«å·®å¼‚ä¸è¡Œä¸šéœ€æ±‚é¢„æµ‹æ¨¡å‹</div>
    </header>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <div class="control-group">
            <label>ğŸ“… æ—¶é—´æ¨æ¼”: <span id="yearVal" class="value-display">2024</span></label>
            <input type="range" id="yearSlider" min="1980" max="2100" value="2024" step="1">
            <div class="desc">æ‹–åŠ¨æŸ¥çœ‹äººå£ç»“æ„æ¼”å˜ (1980 - 2100)</div>
        </div>
        <div class="control-group">
            <label>ğŸ‘¶ æœªæ¥æ€»å’Œç”Ÿè‚²ç‡ (TFR) å‡è®¾: <span id="tfrVal" class="value-display">1.0</span></label>
            <input type="range" id="tfrSlider" min="0.6" max="2.1" value="1.0" step="0.1">
            <div class="desc">0.7=éŸ©å›½æ¨¡å¼ | 1.0=å½“å‰ç°çŠ¶ | 2.1=ä¸–ä»£æ›´æ›¿æ°´å¹³</div>
        </div>
    </div>

    <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
    <div class="kpi-dashboard">
        <div class="kpi-card">
            <div class="kpi-label">æ€»äººå£</div>
            <div class="kpi-val" id="kpi-total">--</div>
            <div class="kpi-note">äº¿äºº</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">æŠšå…»æ¯” (åŠ³åŠ¨åŠ›:è€äºº)</div>
            <div class="kpi-val" id="kpi-support">--</div>
            <div class="kpi-note" id="kpi-support-note">ä¸ªå¹´è½»äººå…»1ä¸ªè€äºº</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">ä¸­ä½æ•°å¹´é¾„</div>
            <div class="kpi-val" id="kpi-median">--</div>
            <div class="kpi-note">å²</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">æ–°ç”Ÿå„¿æ€§åˆ«æ¯”</div>
            <div class="kpi-val" id="kpi-sexratio">--</div>
            <div class="kpi-note">æ¯100å¥³å¯¹åº”çš„ç”·</div>
        </div>
    </div>

    <!-- ä¸ªäººå‘½è¿æ˜ å°„ -->
    <div class="personal-insight">
        <div class="input-group">
            <label>ğŸ‚ è¾“å…¥ä½ çš„å‡ºç”Ÿå¹´ä»½:</label>
            <input type="number" id="userBirthYear" value="1990" min="1950" max="2024">
        </div>
        <div class="insight-text" id="personalReport">
            <!-- JS åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ä¸»å›¾è¡¨ï¼šäººå£é‡‘å­—å¡” -->
    <div class="main-chart-wrapper">
        <div id="mainPyramid"></div>
    </div>

    <!-- è¡Œä¸šè¶‹åŠ¿ -->
    <div class="trend-section">
        <div class="trend-card">
            <div class="trend-title">ğŸ‘¶ å¹¼æ•™/K12éœ€æ±‚ (0-14å²)</div>
            <div id="chart-kids" class="mini-chart"></div>
        </div>
        <div class="trend-card">
            <div class="trend-title">ğŸ  è´­æˆ¿åˆšéœ€ (25-35å²)</div>
            <div id="chart-house" class="mini-chart"></div>
        </div>
        <div class="trend-card">
            <div class="trend-title">ğŸ¥ æ·±åº¦è€é¾„åŒ–/æŠ¤å·¥ (80å²+)</div>
            <div id="chart-elder" class="mini-chart"></div>
        </div>
    </div>

</div>

<script>
    // --- 1. æ•°æ®æºä¸é…ç½® ---

    // å†å²å‡ºç”Ÿæ•°æ® (1949-2023, å•ä½ï¼šä¸‡)
    const historicalBirths = {
        1949:1275,1950:1419,1951:1349,1952:1622,1953:1637,1954:2232,1955:1965,1956:1961,1957:2138,1958:1889,
        1959:1635,1960:1402,1961:949,1962:2451,1963:2934,1964:2721,1965:2679,1966:2554,1967:2543,1968:2731,
        1969:2707,1970:2733,1971:2551,1972:2550,1973:2447,1974:2463,1975:2243,1976:2031,1977:1765,1978:1725,
        1979:1715,1980:1776,1981:2064,1982:2230,1983:2052,1984:2050,1985:2190,1986:2374,1987:2508,1988:2445,
        1989:2396,1990:2374,1991:2250,1992:2113,1993:2119,1994:2098,1995:2052,1996:2057,1997:2028,1998:1934,
        1999:1827,2000:1765,2001:1696,2002:1641,2003:1593,2004:1588,2005:1612,2006:1581,2007:1591,2008:1604,
        2009:1587,2010:1588,2011:1600,2012:1635,2013:1640,2014:1687,2015:1655,2016:1786,2017:1723,2018:1523,
        2019:1465,2020:1200,2021:1062,2022:956,2023:902
    };

    // å‡ºç”Ÿæ€§åˆ«æ¯”æ¨¡æ‹Ÿ (å¤§è‡´å†å²è¶‹åŠ¿)
    function getSexRatioAtBirth(year) {
        if (year < 1980) return 1.06;
        if (year <= 2005) return 1.06 + (year - 1980) * 0.005; // å³°å€¼çº¦1.18
        if (year <= 2020) return 1.18 - (year - 2005) * 0.004;
        return 1.10; // é•¿æœŸå›å½’å‡è®¾
    }

    // --- 2. æ ¸å¿ƒæ¨¡å‹ ---

    // æ­»äº¡ç‡æ¨¡å‹ (å«æ€§åˆ«å·®å¼‚)
    function getSurvivalRate(age, currentYear, sex) {
        // åŒ»ç–—è¿›æ­¥å› å­
        const baseYear = 2020;
        const medicalAdvance = Math.max(0, (currentYear - baseYear) * 0.15); // æœªæ¥åŒ»ç–—è¿›æ­¥
        let effectiveAge = age - medicalAdvance;
        
        // å¥³æ€§å¤©ç”Ÿå¯¿å‘½ä¼˜åŠ¿ (å‡è®¾ç”Ÿç†å¹´é¾„å¹´è½»4å²)
        if (sex === 'female') effectiveAge -= 4;

        if (effectiveAge < 0) return 1;
        
        // æ­»äº¡æ›²çº¿
        if (effectiveAge <= 60) return 0.995 - (effectiveAge * 0.0003);
        if (effectiveAge <= 75) return 0.97 - ((effectiveAge - 60) * 0.008);
        if (effectiveAge <= 85) return 0.85 - ((effectiveAge - 75) * 0.035);
        if (effectiveAge <= 95) return 0.50 - ((effectiveAge - 85) * 0.04);
        if (effectiveAge <= 110) return 0.10 - ((effectiveAge - 95) * 0.01);
        return 0;
    }

    // è·å–æŸå¹´å‡ºç”Ÿäººå£ (ä¿®å¤ç‰ˆï¼šè§£å†³äº†1949å¹´å‰æ•°æ®æº¢å‡ºçš„Bug)
    function getProjectedBirths(birthYear, currentTfr) {
        // 1. å†å²æ•°æ®ä¸­å­˜åœ¨
        if (historicalBirths[birthYear]) return historicalBirths[birthYear];
        
        // 2. å†å²æ•°æ®ä¹‹å‰ (ä¿®å¤ç‚¹ï¼šæ°‘å›½æ—¶æœŸåŠæ›´æ—©)
        // ç®€å•è®¾å®šä¸º1300ä¸‡å·¦å³çš„æ°´å¹³ï¼Œé¿å…è´Ÿå¹´ä»½è®¡ç®—å¯¼è‡´æŒ‡æ•°çˆ†ç‚¸
        if (birthYear < 1949) return 1300; 

        // 3. æœªæ¥æ•°æ®é¢„æµ‹ (2024åŠä»¥å)
        const lastKnown = historicalBirths[2023]; // 902ä¸‡
        const yearsPassed = birthYear - 2023;
        
        // è‡ªç„¶è¡°å‡ç‡
        const naturalDecline = 0.97; 
        // TFR ä¿®æ­£ç³»æ•°
        const tfrFactor = 1 + (currentTfr - 1.1) * 0.05;
        const growthRate = naturalDecline * tfrFactor;
        
        return Math.max(lastKnown * Math.pow(growthRate, yearsPassed), 300); // 300ä¸‡ä¿åº•
    }

    // è®¡ç®—ç‰¹å®šå¹´ä»½çš„å®Œæ•´äººå£ç»“æ„
    function calculateDemographics(targetYear, tfr) {
        let maleData = [];
        let femaleData = [];
        let totalPop = 0;
        
        // è¡Œä¸šç»Ÿè®¡
        let pop0to14 = 0;
        let pop25to35 = 0;
        let pop15to64 = 0; // åŠ³åŠ¨åŠ›
        let pop60plus = 0; // é€€ä¼‘ (å‡è®¾60)
        let pop80plus = 0; // é«˜é¾„
        let newbornMales = 0;
        let newbornFemales = 0;

        let allAges = []; // ç”¨äºä¸­ä½æ•°

        for (let age = 0; age <= 100; age++) {
            let birthYear = targetYear - age;
            let totalBirths = getProjectedBirths(birthYear, tfr);
            
            let sexRatio = getSexRatioAtBirth(birthYear); 
            // ç”· = æ€»æ•° * (SR / (1+SR))
            let mBirths = totalBirths * (sexRatio / (1 + sexRatio));
            let fBirths = totalBirths - mBirths;

            // å­˜æ´»è®¡ç®—
            let mPop = Math.floor(mBirths * getSurvivalRate(age, targetYear, 'male'));
            let fPop = Math.floor(fBirths * getSurvivalRate(age, targetYear, 'female'));
            let agePop = mPop + fPop;

            maleData.push(-mPop); // è´Ÿæ•°ç”¨äºå·¦ä¾§æ˜¾ç¤º
            femaleData.push(fPop);
            totalPop += agePop;
            
            // ç»Ÿè®¡åˆ†ç»„
            if (age <= 14) pop0to14 += agePop;
            if (age >= 25 && age <= 35) pop25to35 += agePop;
            if (age >= 15 && age <= 64) pop15to64 += agePop; 
            if (age >= 60) pop60plus += agePop;
            if (age >= 80) pop80plus += agePop;
            
            if (age === 0) {
                newbornMales = mPop;
                newbornFemales = fPop;
            }

            // ä¸­ä½æ•°è¾…åŠ©
            allAges.push({age: age, count: agePop});
        }

        // è®¡ç®—ä¸­ä½æ•°
        let midCount = totalPop / 2;
        let curr = 0;
        let medianAge = 0;
        for (let item of allAges) {
            curr += item.count;
            if (curr >= midCount) {
                medianAge = item.age;
                break;
            }
        }

        return {
            year: targetYear,
            maleArr: maleData,
            femaleArr: femaleData,
            total: (totalPop / 10000).toFixed(2),
            median: medianAge,
            supportRatio: pop60plus > 0 ? (pop15to64 / pop60plus).toFixed(2) : 'âˆ',
            sexRatioBirth: newbornFemales > 0 ? (newbornMales/newbornFemales*100).toFixed(1) : 0,
            
            // ç»†åˆ†æ•°æ® (ä¸‡)
            valKids: Math.round(pop0to14),
            valHouse: Math.round(pop25to35),
            valElder: Math.round(pop80plus)
        };
    }

    // --- 3. å›¾è¡¨åˆå§‹åŒ– ---
    
    const chartMain = echarts.init(document.getElementById('mainPyramid'));
    const chartKids = echarts.init(document.getElementById('chart-kids'));
    const chartHouse = echarts.init(document.getElementById('chart-house'));
    const chartElder = echarts.init(document.getElementById('chart-elder'));

    // é¢„è®¡ç®—è¶‹åŠ¿æ•°æ®
    function generateTrendSeries(tfr) {
        let years = [];
        let dataKids = [];
        let dataHouse = [];
        let dataElder = [];
        
        for (let y = 1980; y <= 2100; y++) {
            let d = calculateDemographics(y, tfr);
            years.push(y);
            dataKids.push(d.valKids);
            dataHouse.push(d.valHouse);
            dataElder.push(d.valElder);
        }
        return { years, dataKids, dataHouse, dataElder };
    }

    // æ›´æ–°ä¸»å›¾ (é‡‘å­—å¡”)
    function updateMainChart(data) {
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function (params) {
                    let age = params[0].name;
                    let mVal = Math.abs(params[0].value);
                    let fVal = params[1].value;
                    return `<strong>${age} å²</strong> (å‡ºç”Ÿ: ${data.year - age})<br/>
                            <span style="color:var(--male-color)">â™‚ ç”·: ${mVal} ä¸‡</span><br/>
                            <span style="color:var(--female-color)">â™€ å¥³: ${fVal} ä¸‡</span><br/>
                            æ€»è®¡: ${mVal + fVal} ä¸‡`;
                }
            },
            legend: { data: ['ç”·æ€§', 'å¥³æ€§'], bottom: 0 },
            grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
            xAxis: [
                {
                    type: 'value',
                    name: 'äººå£ (ä¸‡)',
                    min: -1500, max: 1500, 
                    axisLabel: { formatter: (v) => Math.abs(v) }
                }
            ],
            yAxis: [
                { type: 'category', axisTick: { show: false }, data: Array.from({length:101},(_,i)=>i), name: 'å¹´é¾„' }
            ],
            series: [
                {
                    name: 'ç”·æ€§',
                    type: 'bar',
                    stack: 'Total',
                    data: data.maleArr,
                    itemStyle: { color: '#5b8ff9', borderRadius: [4,0,0,4] }
                },
                {
                    name: 'å¥³æ€§',
                    type: 'bar',
                    stack: 'Total',
                    data: data.femaleArr,
                    itemStyle: { color: '#e8684a', borderRadius: [0,4,4,0] }
                }
            ],
            animationDuration: 200
        };
        chartMain.setOption(option);
    }

    // æ›´æ–°å°å›¾è¡¨
    function updateTrendCharts(trendData, currentYear) {
        const commonOption = (title, data, color) => ({
            title: { show: false },
            tooltip: { trigger: 'axis' },
            grid: { top: 10, bottom: 20, left: 40, right: 10 },
            xAxis: { type: 'category', data: trendData.years, show: false },
            yAxis: { type: 'value', splitLine: {show: false} },
            series: [{
                type: 'line',
                data: data,
                showSymbol: false,
                lineStyle: { color: color, width: 2 },
                areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:color},{offset:1,color:'#fff'}], false), opacity: 0.3 },
                markLine: {
                    symbol: 'none',
                    label: { show: false },
                    data: [{ xAxis: currentYear - 1980, lineStyle: { type: 'dashed', color: '#333' } }]
                }
            }]
        });

        chartKids.setOption(commonOption('å¹¼æ•™', trendData.dataKids, '#52c41a'));
        chartHouse.setOption(commonOption('æˆ¿äº§', trendData.dataHouse, '#1890ff'));
        chartElder.setOption(commonOption('å…»è€', trendData.dataElder, '#faad14'));
    }

    // ä¸ªäººå‘½è¿è®¡ç®—å™¨
    function updatePersonalInsight(birthYear, currentYear, currentTfr) {
        const age = currentYear - birthYear;
        const retireYear = parseInt(birthYear) + 60;
        const retireData = calculateDemographics(retireYear, currentTfr);
        
        // ä½ çš„åŒé¾„äººæ•°é‡ (å‡ºç”Ÿé‚£å¹´)
        const myBirths = historicalBirths[birthYear] || getProjectedBirths(birthYear, currentTfr);
        
        let html = `<strong>å½“å‰çŠ¶æ€ (${currentYear}):</strong> ä½ ä»Šå¹´ <b>${age}</b> å²ã€‚<br>`;
        
        if (age < 0) {
            html += `ä½ åœ¨ ${-age} å¹´åæ‰ä¼šå‡ºç”Ÿã€‚`;
        } else if (age > 100) {
            html += `é‚£æ˜¯å¾ˆä¹…è¿œçš„æœªæ¥äº†...`;
        } else {
            // é€€ä¼‘é¢„æµ‹
            html += `<strong>é€€ä¼‘é¢„æµ‹ (${retireYear}å¹´):</strong> <br>`;
            html += `å½“ä½ 60å²é€€ä¼‘æ—¶ï¼Œç¤¾ä¼šæŠšå…»æ¯”çº¦ä¸º <b>${retireData.supportRatio}</b> (å³${retireData.supportRatio}ä¸ªå¹´è½»äººå…»1ä¸ªè€äºº)ã€‚<br>`;
            
            if (retireData.supportRatio < 2) {
                html += `<span style="color:red">âš ï¸ è­¦å‘Šï¼šå…»è€é‡‘å‹åŠ›æå¤§ï¼Œå»ºè®®æå‰å‚¨å¤‡èµ„äº§ã€‚</span><br>`;
            }
            
            // åŒé¾„äººç«äº‰
            html += `ä½ çš„åŒé¾„äºº(å‡ºç”Ÿ)çº¦ <b>${Math.round(myBirths)}</b> ä¸‡äººã€‚`;
            if (birthYear >= 1962 && birthYear <= 1975) html += ` (å©´å„¿æ½®ä¸€ä»£ï¼Œäººå¤šæ‹¥æŒ¤)`;
            if (birthYear >= 1990 && birthYear <= 2000) html += ` (ç«äº‰æœ€æ¿€çƒˆçš„ä¸€ä»£)`;
            if (birthYear >= 2020) html += ` (ç¨€ç¼ºçš„ä¸€ä»£ï¼Œä½†æŠšå…»å‹åŠ›å¤§)`;
        }
        
        document.getElementById('personalReport').innerHTML = html;
    }

    // --- 4. äº¤äº’é€»è¾‘ ---

    const sliderYear = document.getElementById('yearSlider');
    const sliderTfr = document.getElementById('tfrSlider');
    const inputBirth = document.getElementById('userBirthYear');
    
    const uiYear = document.getElementById('yearVal');
    const uiTfr = document.getElementById('tfrVal');
    
    // KPI DOM
    const kpiTotal = document.getElementById('kpi-total');
    const kpiSupport = document.getElementById('kpi-support');
    const kpiMedian = document.getElementById('kpi-median');
    const kpiSex = document.getElementById('kpi-sexratio');

    let cachedTrendData = null; 

    function renderAll() {
        const y = parseInt(sliderYear.value);
        const tfr = parseFloat(sliderTfr.value);
        
        uiYear.textContent = y;
        uiTfr.textContent = tfr.toFixed(1);

        // 1. è®¡ç®—å½“å‰æ•°æ®
        const data = calculateDemographics(y, tfr);
        
        // 2. æ›´æ–° KPI
        kpiTotal.textContent = data.total;
        
        kpiSupport.textContent = data.supportRatio;
        kpiSupport.className = 'kpi-val ' + (data.supportRatio < 2 ? 'alert-high' : (data.supportRatio < 3 ? 'alert-mid' : 'alert-safe'));
        
        kpiMedian.textContent = data.median;
        kpiSex.textContent = data.sexRatioBirth;

        // 3. æ›´æ–°ä¸»å›¾
        updateMainChart(data);

        // 4. æ›´æ–°è¶‹åŠ¿å›¾
        // å¦‚æœTFRæ²¡å˜ï¼Œåªæ›´æ–°æ ‡çº¿ä½ç½®ï¼›TFRå˜äº†åˆ™é‡ç®—æ›²çº¿
        if (!cachedTrendData || sliderTfr.dataset.lastVal != tfr) {
            cachedTrendData = generateTrendSeries(tfr);
            sliderTfr.dataset.lastVal = tfr;
        } 
        updateTrendCharts(cachedTrendData, y);

        // 5. æ›´æ–°ä¸ªäººæŠ¥å‘Š
        updatePersonalInsight(inputBirth.value, y, tfr);
    }

    // ç›‘å¬å™¨
    sliderYear.addEventListener('input', renderAll);
    sliderTfr.addEventListener('input', renderAll);
    inputBirth.addEventListener('input', renderAll);
    window.addEventListener('resize', () => {
        chartMain.resize();
        chartKids.resize();
        chartHouse.resize();
        chartElder.resize();
    });

    // åˆå§‹åŒ–
    renderAll();

</script>
</body>
</html>
